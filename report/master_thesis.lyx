#LyX 1.2 created this file. For more info see http://www.lyx.org/
\lyxformat 220
\textclass report
\begin_preamble
\renewcommand{\chaptermark}[1]{\markboth{\thechapter.\ #1}{}}
\fancyhead[LO,RE]{\thepage}
\fancyhead[RO,LE]{\leftmark}
\cfoot{\thepage}
\hyphenation{Micro-Blaze}
\end_preamble
\language english
\inputencoding auto
\fontscheme pslatex
\graphics default
\float_placement htp
\paperfontsize default
\spacing single 
\papersize a4paper
\paperpackage a4
\use_geometry 0
\use_amsmath 0
\use_natbib 0
\use_numerical_citations 0
\paperorientation portrait
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\defskip medskip
\quotes_language english
\quotes_times 2
\papercolumns 1
\papersides 2
\paperpagestyle fancy

\layout Title

Evaluating Xilinx MicroBlaze for 
\newline 
Network SoC solutions
\newline 
\SpecialChar ~

\newline 

\emph on 
Master's Thesis in Computer Engineering
\emph default 

\newline 
\SpecialChar ~

\newline 
--- DRAFT - WORK IN PROGRESS ---
\newline 

\layout Author

Peter Magnusson
\newline 
petmag-8@sm.luth.se
\layout Abstract

This thesis aims to create a System on Chip solution for various network
 devices.
 A solution with network peripherals, processor core and network software
 in a single chip is designed and evaluated.
\newline 

\layout Abstract

Typical applications of a network System on Chip include Ethernet switches,
 Internet-enabled embedded systems, small Internet Protocol clients for
 handheld devices and simple Internet gateways.
\newline 

\layout Abstract

The the solution utilizes the Xilinx MicroBlaze soft processor core, MicroBlaze
 Development Kit, IBM CoreConnect On-Chip Peripheral Bus (OPB) peripherals
 and Xilinx Virtex Field Programmable Gate Array (FPGA).
\layout Chapter*

Acknowledgment
\layout Standard

The evaluation of the Xilinx MicroBlaze has been performed as a Master Thesis
 work in Computer Science and Engineering.
 The work was performed at the Department of Computer Science and Electrical
 Engineering (CSEE) and Embedded Internet Systems Laboratory (EISLAB) at
 Luleå University of Technology.
 
\layout Standard

I wish to thank 
\layout Itemize

Ph.d Per Lindgren for supervising my thesis.
\layout Itemize

Ph.d student Jonas Thor for feedback on various computer engineering topics.
\layout Itemize

M.Sc student Jens Eliasson for various MicroBlaze discussions.
\layout Itemize

M.Sc students Frederik Schmid, Jan Dahlberg, Johan Mattsson, Stefan Nilsson
 and Jimmie Wiklander for reusing and verifying my Ethernet MAC.
\layout Itemize

M.Sc students Stefan Nilsson, Frederik Schmid and Jimmie Wiklander for MicroBlaze
 lwIP implementation.
\layout Itemize

Jens Eliasson, Tim Johansson and Sara Lidqvist for proof-reading my thesis.
\layout Itemize

Xilinx Inc for permitting reprint of figures originally published by Xilinx
 Inc.
\layout Standard

During the thesis work, I have taught MicroBlaze based System on Chip (SoC)
 development to M.Sc students in the Project in Digital Synthesis course
 at CSEE.
 Additional credits goes to these students for valuable input.
\layout Standard


\begin_inset LatexCommand \tableofcontents{}

\end_inset 


\layout Standard


\begin_inset FloatList figure

\end_inset 


\layout Standard


\begin_inset FloatList table

\end_inset 


\layout Chapter


\begin_inset LatexCommand \label{cha:Introduction}

\end_inset 

Introduction
\layout Section

Objectives
\layout Standard

The overall goal of this thesis is to evaluate the Xilinx MicroBlaze soft
 core processor for single chip network solutions, i.e.
 create a MicroBlaze based System On Chip (SoC).
 The SoC should be based on a well verified and evaluated platform.
 Possible future improvement should be well documented.
 To reach these overall goals, a number of objectives were identified:
\layout Itemize

The MicroBlaze Development Kit should be evaluated.
 The evaluation should make clear distinction between peripherals, software
 development tools and tools for platform tailoring.
\layout Itemize

MicroBlaze's bus architecture (CoreConnect On-Chip Peripheral Bus) should
 be evaluated.
\layout Itemize

Network connectivity should be provided through customized Ethernet peripherals.
 Both MII and RMII connectivity should be provided.
\layout Itemize

The XilNet TCP/IP stack for MicroBlaze should be evaluated.
\layout Itemize

The lwIP TCP/IP stack should be ported to MicroBlaze.
\layout Itemize

Availability of other network software for MicroBlaze should be investigated.
\layout Section

Method
\layout Paragraph

Simple MicroBlaze platforms
\layout Standard

were created using MicroBlaze Development Kit.
 MicroBlaze development tutorials 
\begin_inset LatexCommand \cite{MB_TUTORIAL,MB_OPB_TUTORIAL}

\end_inset 

 were used to learn developing MicroBlaze platforms.
\layout Paragraph

Ethernet peripherals
\layout Standard

were developed network enable the MicroBlaze platforms.
 These peripherals were developed for two purposes:
\layout Itemize

to network enable MicroBlaze (MDK does not include network peripherals)
\layout Itemize

to further verify that custom designed peripherals and platforms function
 properly (network applications are easy to monitor remotely for long periods
 of time)
\layout Paragraph

Verification through re-use
\layout Standard

was utilized.
 Five students used, and in one case modified, the Ethernet peripherals
 in the Project in Digital Synthesis course at Luleå University of Technology.
\layout Paragraph

Advanced platform designs
\layout Standard

were investigated.
 The investigated issues included:
\layout Itemize

Custom FPGA buffer-pad insertion
\layout Itemize

Custom OPB bus bindings (e.g.
 dedicated busses, bus bridges)
\layout Paragraph

Re-use of other students projects.
\layout Standard

Fredrik Schmid, Jimmie Wiklander and Stefan Nilsson ported lwIP to MicroBlaze
 for their Digital Synthesis projects.
 In their project they used the Ethernet peripherals and a OPB memory controller
 (developed by Jens Eliasson) for the XESS XSV prototyping boards.
 Their results were incorporated in this thesis.
\layout Paragraph

Publications
\layout Standard

were used to find facts and support statements.
 A problem which occurred was limited availability of MicroBlaze related
 publications.
 Official publications by Xilinx Inc, researchers and other credible sources
 have been used whenever possible.
 Sometimes open forums such as 
\emph on 
Xilinx Embedded Processor Forum
\emph default 
 have been used in lack of more credible sources.
\layout Section

Limitations
\layout Subsection

Time
\layout Standard

This Master Thesis work has been performed during a period of 6 months.
\layout Subsection

Software
\layout Standard

MicroBlaze Development Kit (MDK) 2.2 (Service Pack 2) has been used for this
 evaluation.
 It is the most recent release to date.
\layout Subsection

Hardware
\layout Paragraph

XESS XSV-100 / XSV-800 Prototyping Board
\layout Standard

These are Xilinx Virtex based prototyping board.
 XSV-100 is equipped with a Virtex 100 FPGA, XSV-800 with a Virtex 800 FPGA.
 The Virtex chip is connected to a large set of interfaces, including:
\layout Itemize

Programmable 100 MHz oscillator, 
\begin_inset Formula $f=100/n$
\end_inset 

 MHz, 
\begin_inset Formula $n=1,2,3,4,...$
\end_inset 


\layout Itemize

An MII PHY connected to a RJ45 twisted pair cable socket.
\layout Itemize

Two 512K
\begin_inset Formula $*$
\end_inset 

16-Bit SRAM memory banks.
\layout Paragraph

Platinum Virtex-E Prototyping Board
\layout Standard

This is a prototyping board developed at Luleå University of Technology
 and intended to be available to this thesis work.
 Unfortunately, it was not verified in time to be used in the thesis.
 
\layout Standard

Platinum connects the Virtex-E chip with the following interfaces:
\layout Itemize

Four RMII PHYs, connected to twisted pair cable sockets.
\layout Itemize

One Motorola Microcontroller.
\layout Section

Thesis outline
\layout Standard

\SpecialChar ~

\layout Standard

Chapter 
\begin_inset LatexCommand \ref{cha:Technology-&-Background}

\end_inset 

 covers the technologies which are used and referred to in this thesis.
\layout Standard

Chapter 
\begin_inset LatexCommand \ref{cha:Xilinx-MicroBlaze}

\end_inset 

 introduces Xilinx MicroBlaze and the MDK software.
\layout Standard

Chapter 
\begin_inset LatexCommand \ref{cha:Xilinx-MicroBlaze-as-a-Network-SoC}

\end_inset 

 investigates the possibility of using Xilinx MicroBlaze in a network SoC.
\layout Standard

Chapter 
\begin_inset LatexCommand \ref{cha:Development-of-Microblaze-ethernet-peripherals}

\end_inset 

 outlines the design of a set of Ethernet peripherals for Xilinx MicroBlaze.
\layout Standard

Chapter 
\begin_inset LatexCommand \ref{cha:Comparing-Ethernet-peripherals}

\end_inset 

 compares the Ethernet peripherals designed to a number of other Ethernet
 peripherals.
\layout Standard

Chapter 
\begin_inset LatexCommand \ref{cha:Network-software-for-Microblaze}

\end_inset 

 covers network software, such as TCP/IP stacks, available to Xilinx MicroBlaze.
\layout Standard

Chapter 
\begin_inset LatexCommand \ref{cha:Results}

\end_inset 

 goes back to the objectives states in chapter 
\begin_inset LatexCommand \ref{cha:Introduction}

\end_inset 

 and how those objectives were met.
\layout Standard

Chapter 
\begin_inset LatexCommand \ref{cha:Discussion}

\end_inset 

 discusses the results, suggest some topics for future work and gives a
 number of conclusions drawn from the thesis.
\layout Chapter


\begin_inset LatexCommand \label{cha:Technology-&-Background}

\end_inset 

Technology & Background
\layout Section

System on Chip (SoC) solutions
\layout Standard

System on Chip (SoC) refers to devices where all essential parts of a computing
 systems have been integrated in a single circuit.
 Common SoC design goals include:
\layout Itemize

reduced power dissipation
\layout Itemize

reduced chip interconnects
\layout Itemize

reduced device size
\layout Standard

A typical SoC includes one (or many) processor core(s), an arbitrary number
 of peripherals, some on-chip memory and a bus architecture which interconnects
 all these devices.
 The System on Chip design goal is that only one circuit should required
 for an application.
 In practice a SoC may also contain a large set of I/O interfaces to other
 circuits, for instance: 
\layout Itemize

memory modules 
\layout Itemize

off-chip peripherals 
\layout Itemize

radio transceivers 
\layout Itemize

network interfaces
\layout Standard

As SoCs usually are designed with a limited set of applications in mind,
 they tend to need less processing power than a general purpose computer.
 While a modern workstation operates at clock frequencies in the range of
 500 MHz - 3 GHz, the SoC CPU might operate at just a few megahertz.
 An ideal SoC processor core is operating at the minimum clock frequency
 needed to properly perform the desired task.
 By utilizing a low clock frequency the power consumption and chip temperature
 is reduced.
 This allows SoCs to operate with less cooling devices and better battery/power
 utilization.
\layout Subsection

System on Chip or Microcontroller?
\layout Standard


\begin_inset LatexCommand \cite{FOLDOC}

\end_inset 

 define Microcontroller as:
\layout Quotation

A microprocessor on a single integrated circuit intended to operate as an
 embedded system.
 As well as a CPU, a microcontroller typically includes small amounts of
 RAM and PROM and timers and I/O ports.
 An example is the Intel 8751.
 
\layout Standard

Distinguishing between microcontrollers from SoCs is hard; the words are
 synonyms.
 The word SoC is frequently used in reference to designs which are customized
 for a limited set of applications, while microcontroller tend to be used
 in reference to more general purpose embedded designs.
\layout Section

Application Specific Integrated Circuit (ASIC)
\layout Standard

Application Specific Integrated Circuit (ASIC) is one of the most common
 chip types.
 An ASIC may implement simple designs (
\begin_inset Quotes eld
\end_inset 

application
\begin_inset Quotes erd
\end_inset 

 in ASIC terms) but also large designs such as SoCs.
\layout Standard

An ASIC is designed for a specific application.
 An ASIC can therefor be customized for reduced power dissipation, less
 chip area or greater clock frequencies.
 ASICs usually have low mass production costs.
\layout Standard

ASIC drawbacks are low reconfigurability, long design phases and high startup
 costs.
 
\layout Standard

This makes ASIC well suited for large scale manufacturing of well verified
 designs, but not well suited for prototypes.
\layout Section

Programmable logic device (PLD)
\layout Standard

Programmable logic devices are chips which can be programmed to behave as
 an arbitrary design.
 A PLD may be programmed to implement something as simple as a small net
 of combinatorial logic, but it may also implement large designs such as
 a SoC.
\layout Subsection

Field Programmable Gate Array (FPGA)
\layout Standard

Field Programmable Gate Array (FPGA) is a type of programmable logic devices.
 FPGA is a generic architecture consisting of configurable logic blocks
 and programmable interconnections.
 Several FPGAs contain enough logic to implement SoCs and other large designs.
\layout Standard

FPGAs are not optimized for a specific application, and therefore they may
 consume more power or implement a design less efficient than an ASIC.
 Price per chip is high.
 An FPGA is however easy to reprogram, which shortens design cycles and
 allows early real world tests.
\layout Standard

This makes FPGAs well suited for prototypes and small production volumes.
 FPGA may also be used for applications which are not of ASIC production
 quality.
 An example of this is first generation manufacturing where standards and
 applications are subject to change.
\layout Section

Hardware Description Language (HDL)
\layout Standard

Hardware Description Languages (HDL) provide ways to describe hardware.
 Hardware Description Languages can be used for difference purposes.
 
\layout Paragraph

Synthesis.
\layout Standard

A common usage of HDL is to describe how hardware should be implemented.
 Such descriptions can be translated into technology -dependent netlists
\begin_inset Foot
collapsed false

\layout Standard

Netlists are describe how ASIC or FPGA building blocks are interconnected
 and configured.
\end_inset 

 by software.
 The process of translating HDL descriptions to netlists is known as synthesis.
\layout Paragraph

VHSIC Hardware Description Language (VHDL)
\layout Standard

or 
\begin_inset Quotes eld
\end_inset 

Very High Speed Integrated Circuit Hardware Description Language
\begin_inset Quotes erd
\end_inset 

 is a commonly used HDL.
 It is designed for military and space applications, but is also commonly
 used in academic and commercial hardware project.
 VHDL is similar to software languages such as Ada and Pascal.
\layout Section


\begin_inset LatexCommand \label{sec:Processor-cores}

\end_inset 

Processor cores
\layout Standard

A processor core refers to a processor, 
\emph on 
excluding
\begin_inset Foot
collapsed false

\layout Standard

As opposed to a microcontroller core which may include peripherals.
\end_inset 


\emph default 
 any peripherals it is used with.
 An traditional processor core resides in a dedicated processor chip.
 In SoC designs, one or more processor cores are integrated with peripherals
 on a single chip.
\layout Subsection

Soft, firm and hard cores
\layout Standard

The terms soft, firm and hard cores are originally ASIC manufacturing jargon.
 
\layout Itemize


\begin_inset Quotes eld
\end_inset 

Soft core
\begin_inset Quotes erd
\end_inset 

 refer to cores delivered as a technology dependent gate-level netlist or
 HDL source code.
\layout Itemize


\begin_inset Quotes eld
\end_inset 

Firm core
\begin_inset Quotes erd
\end_inset 

 refer to cores delivered as a library element.
\layout Itemize


\begin_inset Quotes eld
\end_inset 

Hard core
\begin_inset Quotes erd
\end_inset 

 refer to cores which has a fixed physical layout and is incorporated into
 the design as a standard cell.
\layout Standard

Firm and hard cores mainly apply to ASIC design.
 Soft cores are commonly used with programmable logic as well.
\layout Subsection

Instruction Set Architectures
\layout Standard

An Instruction Set Architecture is a definition of how processor should
 perform an instruction.
 An instruction is a very short and basic command to the processor, such
 as 
\begin_inset Quotes eld
\end_inset 

add X with Y and store in Z
\begin_inset Quotes erd
\end_inset 

 or 
\begin_inset Quotes eld
\end_inset 

load X from memory Z
\begin_inset Quotes erd
\end_inset 

.
\layout Paragraph

Reduced Instruction Set Computer (RISC)
\layout Standard

refers to instruction set architectures with all or most of the following
 properties:
\layout Itemize

rapid execution of a small instruction set with simple instructions
\layout Itemize

uniform instruction length
\layout Itemize

all processor registers are general purpose
\layout Itemize

simple addressing modes.
\layout Standard

RISC architectures are commonly used in microcontrollers and System on Chip
 cores.
\layout Subsection

Soft Processors
\layout Standard

Soft Processors are 
\begin_inset Quotes eld
\end_inset 

soft core
\begin_inset Quotes erd
\end_inset 

 processors - delivered as technology dependent netlists or HDL source code
 for synthesis.
 Soft processors have recently gained a lot of popularity.
 The popularity appears to be especially strong among FPGA developers.
 This thanks to several factors: 
\layout Itemize

Performance increases (soft cores are now utilizing FPGA/ASICs better).
\layout Itemize

Increased performance/price ratio on FPGAs.
\layout Itemize

Increased availability of both commercial and academic cores.
\layout Itemize

Free Soft Processors have been released by teams consisting of professionals,
 academics and enthusiasts 
\begin_inset LatexCommand \cite{Site-fpgacpu.org,Site-OpenCores}

\end_inset 

.
\layout Subsection

Why are processor cores and software used?
\layout Standard

Almost any application may be implemented, without a processor or software,
 in application specific logic (e.g.
 ASIC) or programmable logic (e.g.
 FPGA).
 There two major reasons to utilize a processor core and run software on
 it:
\layout Paragraph

Simplicity.
\layout Standard

Software often shorten design times and tend to be easier to develop.
 Software can be partially tested and verified in other environments before
 they are implemented in a particular processor architecture.
 
\layout Paragraph

Simple, fast and remote upgrades.
\layout Standard

Software can often be upgraded during operation without system downtime
\begin_inset Foot
collapsed false

\layout Standard

Downtime is time which a system is off-line, unresponsive or otherwise useless.
\end_inset 

.
 Operating system software often support remote administration and can terminate
 and load a new application in a few microseconds.
 Programmable logic and application specific logic have different upgrade
 characteristics:
\layout Itemize

Programmable logic (e.g.
 FPGA) usually take some time, ranging from a few seconds to a couple of
 minutes, to update.
 Programmable logic is typically not upgraded by remote, although it is
 possible 
\begin_inset LatexCommand \cite{XAPP632_Programming_via_E-Mail}

\end_inset 

.
\layout Itemize

ASICs are very hard to update.
 Support for changes must have been anticipated in advance (several configuratio
n registers or programmable logic blocks included).
 If changes have not been anticipated, a new ASIC may have to be manufactured.
\layout Standard

Software and processor cores are preferred to pure hardware (PLD/ASIC) solutions.
 This is because software adds flexibility, shortens development cycles,
 allows faster reconfigurations and simplifies debugging.
\layout Section

IBM CoreConnect Bus architecture
\layout Standard

IBM CoreConnect 
\begin_inset LatexCommand \cite{CoreConnect_WhitePaper}

\end_inset 

 architecture is a small set of busses intended for SoC designs.
 The design goal of CoreConnect is to provide different busses for different
 types of cores.
 By providing different busses, the overall design may be optimized for
 performance while simple peripherals may be optimized for simplicity.
 
\layout Standard

IBM CoreConnect features three busses:
\layout Itemize

Processor Local Bus (PLB): a high performance bus for interconnecting fast
 processor cores and high performance peripherals (PCI interfaces, memory
 interfaces etc)
\layout Itemize

On-Chip Peripheral Bus (OPB): a simple bus intended for use with peripherals
 which are slow or otherwise unsuited for PLB.
\layout Itemize

Device Control Register Bus (DCR): a simple bus intended to distribute register
 values in an efficient manner.
\layout Standard

An IBM CoreConnect system may utilize one, two or all three busses in a
 single SoC.
 Figure 
\begin_inset LatexCommand \ref{cap:CoreConnect-based-SoC}

\end_inset 

 shows a system utilizing all three busses.
\layout Standard


\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:CoreConnect-based-SoC}

\end_inset 

CoreConnect based SoC
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/coreconnect_system.eps
	display default
	size_type 1
	width 100text%
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\newline 
(from 
\begin_inset LatexCommand \cite{CoreConnect_WhitePaper}

\end_inset 

 page 1)
\end_inset 


\layout Standard

A system utilizing two or three CoreConnect busses may use different system
 clocks - often OPB uses a slower clock than PLB.
 PLB and OPB may be interconnected using OPB-to-PLB and PLB-to-OPB bridges.
 The CoreConnect busses share important characteristics:
\layout Itemize

CoreConnect is fully synchronous
\layout Itemize

CoreConnect does not require tri-state
\begin_inset Foot
collapsed false

\layout Standard

Tri-state drivers are logic which may output boolean values ('0', '1') or
 output no signal.
 Tri-state drivers are notorious for causing design problems, but allows
 several drivers to share a single wire.
 To use or not to use tri-state drivers in bus design is a much debated
 subject.
\end_inset 

 drivers
\layout Standard

IBM CoreConnect is heavily customizable and several CoreConnect architecture
 parameters may differ between different implementations.
 Therefor IBM CoreConnect cores may be incompatible unless designed for
 compliance with a specific CoreConnect implementation.
 Important CoreConnect implementations include: 
\layout Itemize

IBM Blue Logic
\begin_inset ERT
status Collapsed

\layout Standard

\backslash 
texttrademark
\end_inset 

\SpecialChar ~
 Core library for ASIC SoC design.
\layout Itemize

Xilinx OPB for Xilinx FPGA System on Chip design.
\layout Subsection


\begin_inset LatexCommand \label{sec:On-Chip-Peripheral-Bus}

\end_inset 

On-Chip Peripheral Bus (OPB)
\layout Standard

The IBM CoreConnect On-Chip Peripheral Bus
\begin_inset Foot
collapsed false

\layout Standard

Referred to as 
\begin_inset Quotes eld
\end_inset 

OPB
\begin_inset Quotes erd
\end_inset 

 or 
\begin_inset Quotes eld
\end_inset 

OPB Bus
\begin_inset Quotes erd
\end_inset 

 in this paper.
\end_inset 

 is an easy to use bus.
 OPB allows an arbitrary number of masters to read from / write to an arbitrary
 number of slaves.
 Figure 
\begin_inset LatexCommand \ref{cap:IBM-CoreConnect-OPB-Physical-Implementation}

\end_inset 

 shows a small IBM CoreConnect OPB System.
 
\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:IBM-CoreConnect-OPB-Physical-Implementation}

\end_inset 

IBM CoreConnect OPB Physical Implementation
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/IBM_OPB_Physical_implementation.eps
	display default
	size_type 1
	width 90text%
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\newline 
(from 
\begin_inset LatexCommand \cite{CoreConnect_WhitePaper}

\end_inset 

 page 6)
\end_inset 


\layout Standard

The bus includes a data bus and an address bus.
 These busses are usually 32-Bit, 64-Bit or 128-Bit.
 A typical OPB device use the most significant bits of the address bus to
 determine weather it was selected or not, and the least significant bits
 to determine which register (internal address) was accessed.
 
\layout Standard

A normal OPB access can be performed in one cycle.
 Slow OPB devices may respond in an arbitrary number of cycles if issuing
 a 
\begin_inset Quotes eld
\end_inset 

Timeout Suppress
\begin_inset Quotes erd
\end_inset 

 signal.
\layout Standard

When several OPB masters share a bus, an OPB Arbiter is used to grant exclusive
 bus access.
 In these systems, a master may have to wait an arbitrary number of cycles
 until the bus is idle.
 The OPB Arbiter itself may also introduce a short mandatory delay before
 it grant access.
 An OPB master may utilize 
\begin_inset Quotes eld
\end_inset 

Bus Lock
\begin_inset Quotes erd
\end_inset 

 (also referred to as sequential access or bursts) to make several slave
 accesses per arbitrated bus grant.
 Utilization of sequential access keeps arbitration overhead to a minimum.
\layout Subsection


\begin_inset LatexCommand \label{sub:Xilinx-OPB}

\end_inset 

Xilinx OPB
\layout Standard

Xilinx implements the IBM CoreConnect On-Chip Peripheral Bus with most configura
ble OPB parameters set to specific values.
 Both address and data bus is 32-Bit.
 Byte enable signals allow 1, 2 and 4 byte accesses.
 Xilinx OPB Arbiter supports up to 16 masters and allow slow slaves to respond
 in up to 16 cycles without issuing a 
\begin_inset Quotes eld
\end_inset 

Timeout suppress
\begin_inset Quotes erd
\end_inset 

 signal.
 
\layout Standard

Figure 
\begin_inset LatexCommand \ref{cap:Xilinx-OPB-physical}

\end_inset 

 shows a small Xilinx OPB system.
 It is important to note that Xilinx OPB is based on OR-gates and does not
 implement 
\begin_inset Quotes eld
\end_inset 

enable
\begin_inset Quotes erd
\end_inset 

-outputs
\begin_inset Foot
collapsed false

\layout Standard

Xilinx OPB requires that all slave/master peripherals set all output signals
 to logic zero when not selected.
\end_inset 

.
 
\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:Xilinx-OPB-physical}

\end_inset 

Xilinx OPB physical implementation
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/xilinx_opb_physical_implementation.eps
	display default
	size_type 1
	width 90text%
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\newline 
[Figures/Material] based on or adapted from figures and text owned by Xilinx,
 Inc., courtesy of Xilinx, Inc.
 © Xilinx, Inc.
 2001-2002.
 All rights reserved.
\end_inset 


\layout Standard

Because Xilinx OPB devices share the same OPB parameters they are compatible.
 Xilinx OPB devices include Xilinx MicroBlaze soft core processor, Xilinx
 PicoBlaze soft core processor and a large set of OPB peripherals.
 Xilinx also provides a bridge which allows the IBM PPC 440 processor core,
 built into recent Xilinx Virtex II Pro FPGAs, to be interconnected with
 the OPB devices.
\layout Standard

Xilinx provide 
\begin_inset Quotes eld
\end_inset 

OPB Usage Notes
\begin_inset Quotes erd
\end_inset 

 
\begin_inset LatexCommand \cite{MB_HWREF}

\end_inset 

 for mixed systems where Xilinx OPB and other OPB implementations are connected.
 With aid of these usage notes, a broad range of non-Xilinx OPB devices
 may be interconnected with some effort.
\layout Section

Networks and the OSI reference model
\layout Paragraph

The Open Systems Interconnect (OSI) reference model
\layout Standard

is an abstracted approach to computer networks.
 It divides network hardware and software into seven layers.
 The layers are shown in figure 
\begin_inset LatexCommand \ref{cap:OSI-layers}

\end_inset 

.
 
\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:OSI-layers}

\end_inset 

OSI layers
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/osi.eps
	display default
	size_type 1
	width 20page%
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 

 Layer 1, the physical layer, defines how signal is transmitted in cables,
 optical fibers, air or space.
 Layer 2, the Link layer, defines how data should be transmitted between
 two devices.
 Layer 3, the network layer, defines how data should be transmitted between
 a network.
 This thesis deals mainly with layer 2 and 3.
\layout Paragraph

The OSI model applied to Ethernet and Internet.
\layout Standard

Most network protocols can be consider in from an OSI point of view.
 Figure 
\begin_inset LatexCommand \ref{cap:OSI-view-of}

\end_inset 

 visualizes the protocols used in thesis in an OSI view.
\layout Standard


\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:OSI-view-of}

\end_inset 

OSI view of Ethernet - IP network stacks
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/osi_ethernet_ip.eps
	display default
	size_type 1
	width 20page%
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 


\layout Standard

Ethernet is the link layer protocol.
 
\layout Standard

IP (Internet Protocol) is the network layer protocol.
 
\layout Standard

ICMP (Internet Control Message Protocol) is used to send control messages.
 An example of such messages is 
\begin_inset Quotes eld
\end_inset 

No such network
\begin_inset Quotes erd
\end_inset 

, signaled when IP packets with non-existent destinations are detected.
 
\layout Standard

ARP (Address Resolution Protocol) translates network layer addresses into
 link layer addresses.
 ARP is sometimes considered to be a part of the link layer protocols, but
 is better considered to be a glue which keeps link and network layer together.
 
\layout Standard

TCP (Transmission Control Protocol) and UDP (User Datagram Protocol) are
 the transport layer protocols.
\layout Section

About Ethernet 10/100 MBit/s
\layout Standard

Ethernet
\begin_inset Foot
collapsed false

\layout Standard

Any reference to 
\begin_inset Quotes eld
\end_inset 

Ethernet
\begin_inset Quotes erd
\end_inset 

 in this paper refers to the 10/100 MBit/s Ethernet standards.
 Gigabit Ethernet, 10 Gigabit Ethernet, Experimental Ethernet and other
 none 10/100 MBit/s versions of Ethernet are not in the scope of this thesis.
\end_inset 

 
\begin_inset LatexCommand \cite{Book-Gigabit-Ethernet}

\end_inset 

 is a network link (OSI layer 2) protocol.
 Ethernet is by far the most common layer 2 protocol for LANs (Local Area
 Networks).
 An Ethernet Packet (figure 
\begin_inset LatexCommand \prettyref{cap:Ethernet-Packet-Format}

\end_inset 

) includes a 14 byte header (DA, SA, TYPE) and a 46 to 1500 byte DATA section
\begin_inset Foot
collapsed false

\layout Standard

Short packets must be padded with unused 
\begin_inset Quotes eld
\end_inset 

padding
\begin_inset Quotes erd
\end_inset 

 bytes.
 The value of the padding is arbitrary, often the value 0x00 is used.
 More humorous paddings such as 0xBADDCAFE and 0xDEADBEEF are also in use.
\end_inset 

.
 
\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:Ethernet-Packet-Format}

\end_inset 

Ethernet Packet Format
\layout Standard
\align center 

\begin_inset  Tabular
<lyxtabular version="3" rows="3" columns="7">
<features>
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" rightline="true" width="0pt">
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

PREAMBLE
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

SYNCH
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

DA
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

SA
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

TYPE
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

DATA
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

FCS
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

62
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

2
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

6
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

6
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

2
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

46-1500
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

4
\end_inset 
</cell>
</row>
<row bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

bits
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

bits
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

bytes
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

bytes
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

bytes
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

bytes
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

bytes
\end_inset 
</cell>
</row>
</lyxtabular>

\end_inset 


\end_inset 

 In a typical implementation, hardware manages access control, synchronization
 (PREAMBLE, SYNC) and error detection (FCS).
 
\layout Subsection

Link Speed
\layout Standard

Currently most Ethernet devices in use and available for sale are 10/100
 MBit/s; 100 MBit/s but may auto negotiate to 10 MBit/s when interfacing
 10 MBit/s devices.
 Many old devices are 10 MBit/s only.
 
\layout Paragraph

Auto Negotiation
\layout Standard

allows Ethernet devices to sense the link speed capabilities of the receiving
 device and adapt to them.
 The greatest link speed both parties are capable of will be selected.
\layout Paragraph

Link speed in switched full duplex networks
\layout Standard

may vary for each link.
 Figure 
\begin_inset LatexCommand \ref{cap:Link-speeds-in-small-ethernets}

\end_inset 

 shows a small network where end hosts Alice and Bob communicate through
 switches Smith and Summers.
 All are 100 MBit/s capable except Summers, thus the Smith
\begin_inset Formula $\Leftrightarrow $
\end_inset 

Summers and the Summers
\begin_inset Formula $\Leftrightarrow $
\end_inset 

Bob link speed is negotiated to 10 MBit/s.
 The Alice
\begin_inset Formula $\Leftrightarrow $
\end_inset 

Smith link is negotiated to 100 MBit/s.
\layout Standard


\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:Link-speeds-in-small-ethernets}

\end_inset 

Link speeds in a small Ethernet network
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/ethernet_linkspeeds.eps
	display default
	size_type 1
	width 90text%
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 


\layout Subsection

Duplex Mode
\layout Standard

An Ethernet device is either operating in Full Duplex or Half Duplex mode.
 Most Ethernet devices can be configured to Auto Negotiate duplex or to
 use a statically selected duplex mode.
 If possible, hosts will negotiate to Full Duplex.
\layout Subsubsection

Half Duplex
\layout Standard

In Half Duplex, an arbitrary number of Ethernet devices share a single Ethernet
 medium, using the CSMA/CD access protocol.
 Half Duplex does not offer any concurrency; only one device may transmit
 data at a time.
 Half Duplex is an old and inefficient Ethernet mode, although still in
 use in a decreasing number of legacy networks.
\layout Paragraph

CSMA/CD 
\layout Standard

is an abbreviation for the Carrier Sense Multiple Access with Collision
 Detect access protocol.
 In CSMA/CD no host may initiate a packet while carrier (transmission) is
 detected.
 If two devices should initiate transmission at the same time, a collision
 has occurred.
 All hosts should detect collisions and randomly set a 
\begin_inset Quotes eld
\end_inset 

back off
\begin_inset Quotes erd
\end_inset 

 timer and remain silent until it has timed out.
 If repeated collisions occur, greater 
\begin_inset Quotes eld
\end_inset 

back off
\begin_inset Quotes erd
\end_inset 

 values should be randomly selected.
\layout Subsubsection

Full Duplex
\layout Standard

In Full Duplex mode each Ethernet device has a dedicated send medium and
 a dedicated receive medium.
 Interconnections are handled by network switches.
 A special Ethernet PAUSE frame is used to notify a sender that an Ethernet
 device is congested and may not receive more packets for a period of time.
 Depending on network design and switch capacities, Full Duplex may allow
 much more throughput than Half Duplex.
 This because several parallel mediums may be utilized concurrently instead
 of a single shared medium.
\layout Subsection

Ethernet destinations and promiscuous mode
\layout Standard

Hardware may or may not verify destination address (DA).
 Packets can be divided in three classes based upon destination address:
\layout Itemize

Broadcast packets; sent to all hosts
\layout Itemize

Multicast packets; sent to a group of hosts
\layout Itemize

Unicast packets; sent to a specific host
\layout Standard

An end host may consider a packet to be a stray if it is: 
\layout Itemize

a multicast packet sent to a group which the end host does not participate
 in
\layout Itemize

a unicast packet sent to a host other than the receiver
\layout Standard

Stray packets are common in Ethernet.
 Switches in full duplex networks will broadcast multicast/unicast packets,
 if it does not know where the packet should be sent
\begin_inset Foot
collapsed false

\layout Standard

This can be compared to a postman who has received mail for which the recipient'
s address is unknown.
 Instead of discarding the mail, the postman gives a copy of the mail to
 everyone he can find.
 The postman does so in hope that someone else will be able to deliver the
 mail correctly.
\end_inset 

.
 Therefor switches will generate stray packets in full duplex Ethernet networks.
 In half duplex, everyone receives everything.
 Each packet sent will reach the receiver host, but all other hosts will
 receive a stray copy.
\layout Standard

Many end host Ethernet devices drop stray packets instead of passing them
 to software.
 To do the opposite, not drop stray packets, is commonly referred to as
 
\begin_inset Quotes eld
\end_inset 

promiscuous mode
\begin_inset Quotes erd
\end_inset 

.
 Several end host Ethernet peripherals can enable/disable promiscuous mode
 by software.
 Interconnected devices, such as network switches, can be considered to
 always operate in promiscuous mode.
\layout Subsection


\begin_inset LatexCommand \label{sub:MAU-PHY}

\end_inset 

Physical Layer Device (PHY)
\layout Standard

Several different mediums can be used for Ethernet, including coaxial cables,
 optical fibers and twisted pair cables.
 To simplify development, a PHY
\begin_inset Foot
collapsed false

\layout Standard

Physical Layer Device (PHY) is used in Ethernet 10/100 MBit/s references.
 Medium Attachment Unit (MAU) used in Ethernet 10-only MBit/s references.
 In this paper, the term PHY is loosely used in reference to both MAU and
 PHY.
\end_inset 

 handle the OSI Layer 2 (Link) 
\begin_inset Formula $\Leftrightarrow $
\end_inset 

 OSI Layer 1 (Physical) interface.
 
\layout Standard

A PHY is a transceiver which might be able to Auto Negotiate between different
 Ethernet standards.
 There are a number of different PHY standards, which defines how the PHY
 pins should be used by the Ethernet device.
 Since PHYs conform to standards, an Ethernet device does not need to be
 aware of what kind of physical medium is used.
 An Ethernet device may be used with all PHYs which conform to the same
 standard, making the device independent of PHY vendor.
\layout Standard

There are three common PHYs: AUI, MII and RMII.
 Each of them have their own characteristics (as shown in table 
\begin_inset LatexCommand \prettyref{cap:MAU-PHY}

\end_inset 

).
 
\layout Standard

AUI is an old 10 MBit/s only interface.
 
\layout Standard

MII was defined as the 10/100 MBit/s Ethernet was introduced.
 An MII design goal appears to have been to provide a high level of parallelism
 (data width), offering 100 MBit/s at a 25 MHz interface clock.
 
\layout Standard

Reduced MII (RMII) was invented to reduce the interface pin count
\begin_inset Foot
collapsed false

\layout Standard

The number of chip pins utilized.
\end_inset 

.
 A high pin count raises production cost and power dissipation.
 Reducing pin count is a major design concern when designing switches and
 other multi-interface network devices.
 RMII provides 100 MBit/s at a 50 MHz interface clock.
\layout Standard


\begin_inset Float table
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:MAU-PHY}

\end_inset 

Common MAU and PHY protocols
\layout Standard
\align center 

\begin_inset  Tabular
<lyxtabular version="3" rows="4" columns="4">
<features>
<column alignment="left" valignment="top" leftline="true" width="5cm">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" rightline="true" width="0pt">
<row topline="true" bottomline="true">
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

MAU / PHY protocol
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Pins/Interface
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Width
\end_inset 
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

MBit/s
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Attachment Unit Interface (AUI)
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

6 pins
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

1 bit
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

10
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Medium Independent Interface (MII)
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

16 pins
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

 4 bit
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

10/100
\end_inset 
</cell>
</row>
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Reduced Medium Independent Interface (RMII)
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

8 pins
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

2 bit
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

10/100
\end_inset 
</cell>
</row>
</lyxtabular>

\end_inset 


\end_inset 


\layout Chapter


\begin_inset LatexCommand \label{cha:Xilinx-MicroBlaze}

\end_inset 

Xilinx MicroBlaze
\layout Section

The Xilinx MicroBlaze core
\layout Standard

Xilinx MicroBlaze is a small processor core geared for embedded applications
 implemented in Xilinx FPGAs.
 A MicroBlaze platform consists of one or several MicroBlaze cores and a
 set of peripherals and an interconnecting OPB bus architecture.
\layout Standard

The MicroBlaze core is a high performance, among the fastest available 
\begin_inset LatexCommand \cite{MicroBlaze_WWW}

\end_inset 

 to Xilinx FPGAs, 32-bit RISC soft core processor.
 The core consists of a three stage pipeline with dedicated instruction
 and data paths (Harvard-style).
 The core is illustrated in figure 
\begin_inset LatexCommand \ref{cap:MicroBlaze-Core-Block-Diagram}

\end_inset 

.
\layout Standard


\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:MicroBlaze-Core-Block-Diagram}

\end_inset 

MicroBlaze Core Block Diagram
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/microblaze_core_block_diagram.eps
	display default
	size_type 1
	width 90text%
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\newline 
 [Figures/Material] based on or adapted from figures and text owned by Xilinx,
 Inc., courtesy of Xilinx, Inc.
 © Xilinx, Inc.
 2001-2002.
 All rights reserved.
\end_inset 


\layout Subsection

Xilinx MicroBlaze bus interfaces
\layout Standard

The MicroBlaze core contains two OPB master interfaces, IOPB which provides
 an instruction path and DOPB which provides a data path.
 The core also contains two Local Memory Buses (LMB) interfaces, ILMB which
 provides an instruction path and DLMB which provides a data path.
 
\layout Standard

A MicroBlaze platform must include a data path and an instruction path connected
 to the MicroBlaze core, therefor it will utilize 2, 3 or 4 bus interfaces.
\layout Subsubsection

Local Memory Bus (LMB)
\layout Standard

The LMB bus is a highly optimized architecture, exploiting the Xilinx Dual
 Port Block RAM support for two concurrent single-cycle memory access.
 This enables single-cycle concurrent ILMB and DLMB access, making a MicroBlaze
 platform with only LMB access extremely efficient.
 
\layout Subsubsection


\begin_inset LatexCommand \label{sub:Microblaze-OPBs}

\end_inset 

On-Chip Peripheral Bus (OPB)
\layout Standard

Xilinx MicroBlaze is compatible with several other OPB devices, as stated
 in section 
\begin_inset LatexCommand \ref{sub:Xilinx-OPB}

\end_inset 

.
 MicroBlaze's use of a dedicated data path (DOPB) and a dedicated instruction
 path (IOPB) allows several different bus configurations.
 The MicroBlaze platform may be configured to utilize the MicroBlaze architectur
e in a manner optimized for the application.
 
\layout Standard

Examples of customized bus configurations are:
\layout Itemize

Dual Port RAM configuration (figure 
\begin_inset LatexCommand \ref{cap:MicroBlaze-OPB-Configuration-DP-RAM}

\end_inset 

).
 IOPB and DOPB both interface a single Dual Port RAM.
 This provides a shared, high speed instruction / data memory space.
 IOPB and DOPB may act concurrently and independently.
 This is similar to the LMB architecture which also utilize a Dual Port
 RAM.
 The downside is that Dual Port RAM tend to be more expensive than single
 port RAM and utilize more I/O pins.
\layout Itemize

DOPB to IOPB Bridge configuration (figure 
\begin_inset LatexCommand \ref{cap:MicroBlaze-OPB-Configuration-OPB-Bridge}

\end_inset 

).
 IOPB and DOPB are bridged, and the bridge will act as a DOPB slave and
 an IOPB master.The bridge allows IOPB and DOPB to act concurrently and independe
ntly except when DOPB access IOPB memory.
 This is less expensive than a Dual Port RAM while almost as fast in application
s which does not read/write to memory often.
 
\layout Itemize

IOPB ROM configuration (figure 
\begin_inset LatexCommand \ref{cap:MicroBlaze-OPB-Configuration-ROM}

\end_inset 

).
 This configuration utilizes that many application never need to write to
 instruction memory, and thus may store it in a Read-Only Memory (ROM).
 IOPB and DOPB may act concurrently independently.
\layout Itemize

IOPB and DOPB interconnect configuration (figure 
\begin_inset LatexCommand \ref{cap:MicroBlaze-OPB-Configuration-connected}

\end_inset 

).
 This is a low speed configuration.
 DOPB and IOPB are connected to the same bus, and they may not operate concurren
tly.
 It is a simple, slow and cheap solution.
 
\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:MicroBlaze-OPB-Configuration-DP-RAM}

\end_inset 

MicroBlaze OPB Configuration - Dual Port RAM
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/microblaze_config_dpram.eps
	display default
	size_type 1
	width 90text%
	scale 25
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 


\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:MicroBlaze-OPB-Configuration-OPB-Bridge}

\end_inset 

MicroBlaze OPB Configuration - OPB Bridge
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/microblaze_config_bridge.eps
	display default
	size_type 1
	width 90text%
	scale 25
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 


\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:MicroBlaze-OPB-Configuration-ROM}

\end_inset 

MicroBlaze OPB Configuration - ROM
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/microblaze_config_rom.eps
	display default
	size_type 1
	width 90text%
	scale 25
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 


\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:MicroBlaze-OPB-Configuration-connected}

\end_inset 

MicroBlaze OPB Configuration - IOPB & DOPB interconnected
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/microblaze_config_connected.eps
	display default
	size_type 1
	width 90text%
	scale 25
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 


\layout Subsubsection

Memory considerations
\layout Standard

Many FPGAs contain only a few kilobytes of Block RAM.
 An expensive FPGA (such as a Virtex-II Pro XC2VP125) may contain more than
 a megabyte of Block RAM.
 
\layout Standard

Applications with large buffers requirements such as network switches or
 routers are hard to fit even in expensive FPGA.
\layout Standard

LMB-only memory solutions are therefor suited only for a limited range of
 applications.
 Many applications require external memory, accessed through the OPB bus.
\layout Section

Embedded Development Kit (EDK)
\layout Standard

Xilinx main development kit for embedded applications and SoCs is the Embedded
 Development Kit (EDK).
 It contains a large set of OPB peripherals, Xilinx MicroBlaze soft processor,
 Xilinx PicoBlaze soft processor and a powerful up to date development kit.
\layout Section

MicroBlaze Development Kit (MDK)
\layout Standard

MDK is a stripped down version of EDK containing less peripherals.
 The software in MDK is based upon an old version of EDK.
\layout Subsection

MicroBlaze peripherals included in MDK
\layout Standard

MDK includes ten standard OPB peripherals, such as Memory Controller, UART,
 Watchdog, JTAG_UART, and Interrupt controller.
 One peripheral is an OPB Arbitrator which allows up to 16 masters to share
 the OPB Bus.
 Xilinx also provides documentation and tutorials on the subject of designing
 custom OPB Slaves for MicroBlaze platforms.
\layout Subsection

MDK platform tailoring utilities
\layout Standard

A MicroBlaze platform is specified in a MicroBlaze Hardware Specification
 (MHS) configuration file.
 Typical MHS options include which bus configuration to use and which peripheral
s to interface.
 
\layout Standard

The Platform tailoring utility is named Platform Generator (usually referred
 to by the acronym 
\begin_inset Quotes eld
\end_inset 

platgen
\begin_inset Quotes erd
\end_inset 

).
 Platgen builds MicroBlaze platforms through an automated process.
 The process includes creating top modules and launching project synthesis.
 Platgen input is the MHS file and a small set of command line parameters.
 
\layout Standard

MDK platgen is moderately simple and able to cope with most beginners' design
 issues.
\layout Subsection

MDK software development tools
\layout Standard

MDK includes most common development tools such as an assembler, a compiler,
 a linker, a debugger, a makefile interpreter and some other utilities.
 All these tools are based on famous and well verified GNU tools.
 This is a major benefit as many developers have previous experience with
 these or similar tools
\begin_inset Foot
collapsed false

\layout Standard

Several GNU tools, such as the C compiler, behaves similar to common UNIX
 tools.
\end_inset 

.
\layout Standard

The debugger is interfaced by JTAG
\begin_inset Foot
collapsed false

\layout Standard

JTAG is a chip test interface.
 Often is used to verify successful ASIC manufacturing.
\end_inset 

 or RS-232 serial line interface.
 Any debugger supporting either the GNU Debugger Remote Protocol or the
 Unified Debugging Interface standard may be used to debug MicroBlaze platforms.
 This allows a broad range of debuggers and debugger GUIs to be used with
 a MicroBlaze platform.
\layout Paragraph

Library Generator
\layout Standard

(
\begin_inset Quotes eld
\end_inset 

libgen
\begin_inset Quotes erd
\end_inset 

) is a small script which prepares a MicroBlaze software system.
 Libgen utilizes a small set of standard libraries (libc, libm etc) and
 source code from peripherals' driver directories.
 Libgen reads a MicroBlaze Software Specification (MSS) configuration file
 and the MicroBlaze Hardware Specification (MHS) file.
 MSS specifies e.g.
 drivers to include.
 When executed, libgen compiles all drivers configured to be used and adds
 the compiled drivers to the libc library.
 C header files from the drivers are copied to the project's include path.
 Finally libgen creates 
\emph on 
mbio.h
\emph default 
, a C header file which defines each base address of any peripheral included
 in the MicroBlaze platform.
\layout Paragraph

Final compilation and linking
\layout Standard

of the project's main source code performed using the associated C header
 files and the modified libc library.
\layout Subsection

Problems with MDK
\layout Standard

There are some problems with MDK which have been encountered.
 These problems include lack of in depth documentation for certain issues
 and limitations in the MDK platform tailoring utility.
\layout Subsubsection

MDK Documentation
\layout Standard

The documentation 
\begin_inset LatexCommand \cite{MB_HWREF,MB_SWREF,MB_TUTORIAL,MB_OPB_TUTORIAL}

\end_inset 

 included in MDK is sufficient for beginner's applications.
 In some issues, in depth information is hard to find.
 When searching at Xilinx (or common Internet search engines such as Google
 or Altavista) information regarding EDK is usually found rather than MDK.
\layout Subsubsection

MDK platform tailoring limitations - OPB bus configuration
\layout Standard

MDK can be configured to use no OPB bus, an instruction bus (IOPB) only,
 a data bus (DOPB) only or both OPB busses.
 MicroBlaze may utilize IOPB and DOPB in several different ways, allowing
 application specific customization as described in section 
\begin_inset LatexCommand \ref{sub:Microblaze-OPBs}

\end_inset 

.
\layout Standard

However, MDK only allow the designer to specify which OPB/LMB interfaces
 to implement.
 MDK does not offer any configuration options for controlling if - or how
 - busses should be interconnected.
 
\layout Standard

If both DOPB and IOPB are used, they will be connected to the same bus (shown
 in figure 
\begin_inset LatexCommand \ref{cap:MicroBlaze-OPB-Configuration-connected}

\end_inset 

).
 When executing software from the shared bus it will be heavily utilized,
 bus delays will increase and data throughput will decrease.
 A shared bus has a significant negative performance impact.
\layout Standard

Additionally, MDK does not include any OPB-to-OPB bridge.
\layout Standard

EDK offers a number of measures to remedy these problems through a set of
 MHS directives which are not available in MDK.
 To customize OPB in MDK, a designer must venture beyond platgen and modify
 automatically generated VHDL files.
 This means that when designing advanced MicroBlaze platform, a designer
 loose a lot of time and effort saving automation.
\layout Standard

This was discussed in 
\begin_inset LatexCommand \cite{XEPF-Platgen-OPB-Limitation}

\end_inset 

 where Xilinx staff replied that it would be fixed before the end of summer
 2002.
 Apparently Xilinx did not to update MDK.
 Possibly Xilinx put their efforts into EDK instead.
\layout Subsubsection

MDK platform tailoring limitations - buffers and pads configuration
\layout Paragraph

Buffers.
\layout Standard

A Virtex FPGA input/output pin is connected to a 
\begin_inset Quotes eld
\end_inset 

pad
\begin_inset Quotes erd
\end_inset 

.
 Each Virtex FPGA contains four global clock pads.
 These pads are specifically used for clock signals.
 Each pad is in turn connected to a buffer.
 The buffer-pad combination decides how a pin may be interfaced by the design.
 There are a number of different buffers which each has its own purpose
 and characteristics.
 
\layout Paragraph

MDK platgen buffer options.
\layout Standard

MDK platgen can be configured to insert buffers or not insert buffers.
 
\layout Standard

When inserting buffers, MDK platgen will auto-insert buffers as stated in
 table 
\begin_inset LatexCommand \ref{cap:Auto-inserted-buffers}

\end_inset 

.
 These are the common buffers usually required by a design.
\layout Standard

When configured to not insert buffers, MDK platgen will generate a netlist
 without pads (often referred to as black box or soft core).
 The netlist may be utilized as a component in a larger design.
 The netlist can also be used in a small wrapper top entity which defines
 which buffer should be used for each I/O signal.
\layout Paragraph

The buffer problem.
\layout Standard

There are cases when the design require specific buffers.
 An example of this is when a designer wish to implement a synchronous Ethernet
 peripheral on a prototype board with RX_CLK, TX_CLK or REF_CLK connected
 to a global clock pad.
 An input which is not used as a clock will be buffered with an Input Buffers
 (IBUF).
 But an IBUF cannot be connected to global clock pad.
 In this case a Dedicated Input Buffer (IBUFG) must be used.
\layout Paragraph

Solutions.
\layout Standard

This problem can be solved by not inserting buffers and utilizing a small
 wrapper as the top entity.
 Scripted modifications of generated top entities can also be used.
 
\begin_inset Float table
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:Auto-inserted-buffers}

\end_inset 

MDK synthesis auto-inserted buffers
\layout Standard
\align center 

\begin_inset  Tabular
<lyxtabular version="3" rows="5" columns="2">
<features>
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="left" valignment="top" leftline="true" rightline="true" width="0pt">
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Buffer
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Inserted at I/O signals used as
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

BUFGP
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Clock signals
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

IBUF
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

General input
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

OBUF
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

General output
\end_inset 
</cell>
</row>
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

IOBUF
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Tristate input/output
\end_inset 
</cell>
</row>
</lyxtabular>

\end_inset 


\end_inset 


\layout Subsubsection

MDK platform tailoring limitations - Tristate design style
\layout Standard

Another issue is that tristate buffers in peripherals must be written as
 a set of three I/O signals (input, output and tristate control) as shown
 in figure 
\begin_inset LatexCommand \ref{cap:MicroBlaze-platform-with-tristate}

\end_inset 

.
 Although this is not a major drawback when designing custom components,
 it is an unnecessary design restriction.
 Specifically it may limit which third party OPB components (distributed
 as netlists or source code) which are easy to utilize in a MicroBlaze periphera
l design.
 
\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:MicroBlaze-platform-with-tristate}

\end_inset 

MicroBlaze platform with tristate peripheral
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/tristate_peripheral.eps
	display default
	size_type 1
	width 90text%
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 


\layout Chapter


\begin_inset LatexCommand \label{cha:Xilinx-MicroBlaze-as-a-Network-SoC}

\end_inset 

Xilinx MicroBlaze as a Network SoC
\layout Section

MicroBlaze as a SoC system
\layout Standard

The MicroBlaze Development Kit is geared at developing System on Chip solutions.
 All standard peripherals are implemented on the same chip (FPGA) as the
 MicroBlaze core.
 It also contains typical I/O peripherals for microcontrollers and SoCs,
 such as RS-232 serial line interface, memory controller (intended for SRAM
 and FlashRAM), General Purpose I/O and others.
\layout Section

MicroBlaze Network Support
\layout Standard

MicroBlaze Development Kit does not include any network peripherals.
 This is obviously a drawback when designing network SoCs.
 However there are two MicroBlaze compatible OPB Ethernet peripherals available
 for sale at Xilinx.
 One of these is a small and simple Ethernet peripheral.
 The other is a professional Ethernet peripheral which is highly configurable
 and support most Ethernet modes.
 In a commercial SoC project, buying either of these peripherals is simple
 way to get a well verified peripheral.
\layout Subsection

Customized Ethernet peripheral
\layout Standard

Custom design of an Ethernet peripheral may be preferred in SoC design,
 especially in application specific SoCs.
 A custom made peripheral may yield a number of interesting properties:
\layout Itemize

Cheap
\layout Itemize

Area, performance and features may be customized for a specific application
\layout Standard

The level of application specific customization is of interest in a large
 number of projects.
 A few examples of interesting customizations are:
\layout Itemize

Speed or area optimized design
\layout Itemize

DMA or register access
\layout Itemize

Promiscuous mode or not
\layout Itemize

Hardware support for Ethernet multicast
\layout Itemize

Classification, validation, or special handling of certain Ethernet frames
\layout Standard

Classification, validation, and special handling of certain Ethernet frames
 is performed by most Ethernet peripherals, as it is a requirement for IEEE
 Ethernet standard compliance
\begin_inset Foot
collapsed false

\layout Standard

It may also be performed in software.
\end_inset 

.
 A typical Ethernet peripheral will verify Ethernet frames and take special
 actions upon receipt of Ethernet PAUSE frames.
 It would not be difficult to extend such a classification module to also
 handle layer 3 frames (such as IPv4) to reduce MicroBlaze CPU utilization.
 By decreasing CPU utilization the software application can be simplified
 or power dissipation may be reduced.
\layout Chapter


\begin_inset LatexCommand \label{cha:Development-of-Microblaze-ethernet-peripherals}

\end_inset 

Development of MicroBlaze Ethernet peripherals
\layout Section

Design requirements and limitations
\layout Subsection

Full Duplex only
\layout Standard

In principal, supporting the entire range of Full/Half/Auto Duplex combinations
 is easy, but it takes time and effort to develop and verify.
 For simplicity, all Ethernet peripherals were developed for Full Duplex
 only, which is by far the most common Ethernet Duplex mode today.
\layout Subsection

Ethernet Interfaces (PHY): MII and RMII
\layout Standard

The Ethernet peripherals were designed to be used on two different prototype
 boards, one based on an MII Ethernet Interface and one based on a Reduced
 MII (RMII) Ethernet Interface.
 The designs therefor needed to support both interfaces.
\layout Section

Implementation
\layout Subsection

Eth Version 1.00, Revision A
\layout Standard

Eth Version 1.00 Revision A is designed to be a very simple MAC, portable
 to most FPGA and prototype boards.
\layout Subsubsection

Fully synchronous, single edge triggered
\layout Standard

To simplify design and verification, no asynchronous logic is used in the
 design.
 Additionally, only flip flops triggered by system clock rising edge are
 used.
 Figure 
\begin_inset LatexCommand \ref{cap:EthV100A-InputToOutput-illustration}

\end_inset 

 illustrates how an input clock rising edge (a 
\begin_inset Quotes eld
\end_inset 

001
\begin_inset Quotes erd
\end_inset 

 pattern) is detected and output is triggered by rising edge.
 
\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:EthV100A-InputToOutput-illustration}

\end_inset 

Eth Version 1.00 Revision A, Input to Output illustration
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/ethv100a_txclocking.eps
	display default
	size_type 1
	width 90text%
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 


\layout Standard

It should be noted that due to this design choice, Ethernet Interface clocks
 must be sampled fast enough to detect rising edge and change values prior
 to falling edge.
 The system clock must therefor be approximately 5 times faster than Ethernet
 interface clocks.
 Table 
\begin_inset LatexCommand \prettyref{cap:Min-SysClk}

\end_inset 

 shows the interface clocks and resulting minimal system clock frequency.
 
\begin_inset Float table
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:Min-SysClk}

\end_inset 

Minimum System Clock for reliable synchronous Ethernet sampling
\layout Standard
\align center 

\begin_inset  Tabular
<lyxtabular version="3" rows="5" columns="3">
<features>
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" rightline="true" width="0pt">
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Interface
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Interface Clock
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Minimum System Clock
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

MII 10 MBit
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

2.5 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

12.5 MHz
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

MII 100 MBit
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

25 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

125 MHz
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

RMII 10 MBit
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

5 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

25 MHz
\end_inset 
</cell>
</row>
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

RMII 100 MBit
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

50 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

250 MHz
\end_inset 
</cell>
</row>
</lyxtabular>

\end_inset 


\end_inset 


\layout Paragraph

Why synchronous and single edge triggered flipflops?
\layout Standard

One reason is that asynchronous logic and systems triggered both edges are
 harder to verify.
 Asynchronous operations may introduce hard to find race conditions and
 errors which rarely occur in simulations.
\layout Standard

Another reason is that asynchronous logic in Xilinx Virtex FPGA implementations
 require a global clock net dedicated each interface clock (MII uses two
 clocks, RMII uses one).
 Xilinx Virtex only provide four dedicated clock pads 
\begin_inset LatexCommand \cite{VIRTEX}

\end_inset 

.
 Synchronous solutions therefor enables multi-interface designs in Xilinx
 Virtex FPGA.
\layout Subsubsection

System Clock and Performance Impact
\layout Standard

A MicroBlaze platform consisting of Eth Version 1.00 Revision A, the OPB
 bus and the MicroBlaze core was created.
 The platform was synthesized and implemented for a Virtex 800 speedgrade
 4 FPGA.
 
\layout Standard

Maximum system frequency for the platform proved to be 50 - 60 MHz
\begin_inset Foot
collapsed false

\layout Standard

Utilizing a Place And Route overall effort of 5.
\end_inset 

.
 As shown in table 
\begin_inset LatexCommand \prettyref{cap:Min-SysClk}

\end_inset 

, this only enables 10 MBit/s implementations.
\layout Standard

Eth Version 1.00 Revision A bus is operating at 50 MHz, 32-bit data-width
 and three cycle access time.
 This yields a maximum switching capacity of 
\layout Standard
\align center 

\begin_inset Formula $\frac{32\, \textrm{bit}\, *50\, \textrm{M}\, \textrm{cycles/s}}{3\, \textrm{cycles}}=533\, \textrm{MBit/s}$
\end_inset 

.
\layout Standard

This should be enough for a very large number of 10 MBit/s devices.
 
\layout Subsubsection

Modular design
\layout Standard

To provide a simple, extendible and reusable interface, each component is
 designed with modularity and re-usability in mind.
 
\layout Standard

All send-logic in a transmit (TX) core (figure 
\begin_inset LatexCommand \prettyref{cap:TX-Core}

\end_inset 

) and all receive-logic is placed in a receive (RX) core (figure 
\begin_inset LatexCommand \prettyref{cap:RX-Core}

\end_inset 

).
 The cores are mapped into a small top-module which handles bus interconnections.
 As shown in table 
\begin_inset LatexCommand \prettyref{cap:EthModules}

\end_inset 

, all parts of the design have been kept at a small number of short and
 easily read VHDL files.
\layout Standard


\begin_inset Float table
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:EthModules}

\end_inset 

Eth Version 1.00 Revision A VHDL files
\layout Standard
\align center 

\begin_inset  Tabular
<lyxtabular version="3" rows="5" columns="3">
<features>
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" rightline="true" width="0pt">
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Modules
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

VHDL Files/Entities
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Average number of lines per file
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

General
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

4
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

93
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

RX Core
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

7
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

112
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

TX Core
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

6
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

133
\end_inset 
</cell>
</row>
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

OPB Slave
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

1
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

250
\end_inset 
</cell>
</row>
</lyxtabular>

\end_inset 


\end_inset 


\layout Subsection

Eth Version 1.00 Revision C
\layout Standard

This is a redesign of Eth V.100 Revision A.
 It is designed to reach 100 MBit at target technology MII, Virtex 800 speedgrad
e -4 with system clock set to 50 MHz.
\layout Subsubsection

Asynchronous
\layout Standard

This peripheral utilizes three clocks: the OPB system clock, the MII RX_CLK
 and the MII TX_CLK.
 The MII clocks are significantly slower (25 MHz at 100 MBit/s) than the
 system clock.
 This is utilized to reduce most of the peripheral's clock frequency.
 Only the register files and the top module is clocked by system clock,
 most of the design is clocked by MII clocks.
\layout Paragraph

Clock pad utilization.
\layout Standard

This peripheral utilizes three out of four Xilinx Virtex 
\begin_inset LatexCommand \cite{VIRTEX}

\end_inset 

 clock pads.
 The clock pad utilization restrict the design to platforms with a single
 Ethernet peripheral.
\layout Paragraph

Reduced power dissipation.
\layout Standard

Thanks to its asynchronous design, a large part of the design may operate
 at low clock frequencies.
 These low, system clock independent, clock frequencies allows reduced power
 dissipation.
\layout Paragraph

Open Loop and minimum system clock frequency.
\layout Standard

The design utilizes open loop 
\begin_inset LatexCommand \cite{XTE-Asynchronous}

\end_inset 

 solutions to move from Ethernet clock domains to system clock domain.
 The open loop requires system clock to always be faster than interface
 clocks.
 Utilizing the variables in table 
\begin_inset LatexCommand \ref{cap:Open-Loop-MinSysClk}

\end_inset 

 the timing requirements may be expressed as:
\layout Standard
\align center 

\begin_inset Formula $t_{sysclk}\, +\, \left|d_{sysclk}\right|\, \leq \, t_{phyclk}\, -\, \left|d_{phyclk}\right|$
\end_inset 


\layout Standard

This formula may be rewritten as:
\layout Standard
\align center 

\begin_inset Formula $f_{sysclk}\, \geq \, \frac{1}{t_{phyclk}\, -\, \left|d_{phyclk}\right|\, -\, \left|d_{sysclk}\right|}$
\end_inset 


\layout Standard


\begin_inset Float table
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:Open-Loop-MinSysClk}

\end_inset 

Open Loop - Minimum system clock frequency
\layout Standard
\align center 

\begin_inset  Tabular
<lyxtabular version="3" rows="6" columns="2">
<features>
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="left" valignment="top" leftline="true" rightline="true" width="0pt">
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Variable
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Denotes
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard


\begin_inset Formula $f_{sysclk}$
\end_inset 


\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

System clock frequency 
\begin_inset Formula $\left(Hz\right)$
\end_inset 


\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard


\begin_inset Formula $t_{phyclk}$
\end_inset 


\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Ethernet PHY clock period 
\begin_inset Formula $\left(s\right)$
\end_inset 


\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard


\begin_inset Formula $t_{sysclk}$
\end_inset 


\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

System clock period 
\begin_inset Formula $(s)$
\end_inset 


\end_inset 
</cell>
</row>
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard


\begin_inset Formula $d_{phyclk}$
\end_inset 


\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Ethernet PHY clock drift, worst case 
\begin_inset Formula $\left(s\right)$
\end_inset 


\end_inset 
</cell>
</row>
<row bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard


\begin_inset Formula $d_{sysdrift}$
\end_inset 


\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

System clock drift, worst case 
\begin_inset Formula $\left(s\right)$
\end_inset 


\end_inset 
</cell>
</row>
</lyxtabular>

\end_inset 


\end_inset 

 It is reasonable to assume 
\begin_inset Formula $\left|d_{sysclk}\right|$
\end_inset 

 to be small because a system clock oscillator is usually very exact.
 
\begin_inset Formula $\left|d_{phyclk}\right|$
\end_inset 

may however be large; Ethernet receiver clocks must synchronize against
 Ethernet transmitter clocks which could possibly be skewed.
 During synchronization, Ethernet clocks will drift.
 Assuming clock drift worst case of 
\begin_inset Formula $\pm 19\%$
\end_inset 

 
\begin_inset Foot
collapsed false

\layout Standard

A simulation testbench for verification of academic Ethernet peripherals
 (supplied by Robert Wikander of Switchcore AB) have a 
\begin_inset Formula $\frac{\left|d_{phyclk}\right|}{t_{phyclk}}<19\%$
\end_inset 

 worst case clock drift.
 The testbench simulate interface clock drift but assume system clock drift
 to be zero.
\end_inset 

 yields that system clock must be 23% faster than interface clock.
\layout Standard

Figure 
\begin_inset LatexCommand \ref{cap:Open-Loop-Race-Condition}

\end_inset 

 illustrates the race condition which eventually will occur if the timing
 requirements requirement is not met; the system clock domain fails to sample
 valid data.
 
\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:Open-Loop-Race-Condition}

\end_inset 

Open Loop Race Condition
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/openloop_worstcase.eps
	display default
	size_type 1
	width 40page%
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 


\layout Section

Verification
\layout Subsection

Testbench
\layout Standard

The testbench was designed to be modular and to be able to simulated different
 input.
 This was archived by abstracting input/output verification into two submodules,
 and by reading Ethernet input from file.
 The testbench design is shown in 
\begin_inset Float figure
wide false
collapsed false

\layout Caption

Modular Testbench
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/testbench1.eps
	display default
	size_type 2
	scale 50
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 

.
 The testbench were also designed to allow commonly performed quick tests
 (regression test).
 
\layout Subsubsection

Regression tests
\layout Standard

Testbenches were automated and generate logfiles containing assertion notes,
 warnings and errors.
 Human inspection of waveforms were therefor rarely needed to verify that
 recently added code does not break previous functionality.
 Regression tests proved to be a highly useful tool and shortened verification
 cycles considerably by automatically finding errors in designs.
\layout Subsubsection

Modular testbench: Ethernet Model
\layout Standard

To simplify the main testbench, verification of Ethernet correctness is
 performed in a stand alone model.
 The model identifies short packets, long packets, short interframe gaps,
 incorrect FCS and a number of other Ethernet violations.
 Ethernet violations will cause warning assertions.
 Correct packets will cause assertion notes, representing the packet in
 hexadecimal notation.
\layout Subsubsection

Modular testbench: OPB Model / Loopback
\layout Standard

This model models the OPB bus.
 The model serves two main purposes: OPB Verification and Loopback.
\layout Subsubsection*

OPB Verification
\layout Standard

Verification of OPB behavior correctness is performed in the OPB Loopback
 Model.
 The model is able to identify several possible violations of the OPB bus.
 This part of the model is not directly Eth Version 1.00 specific.
 Improvements must however be made before it is reusable as a general purpose
 Xilinx OPB verification model.
\layout Subsubsection*

Loopback
\layout Standard

The model also acts as a loopback device: Any packet received by the model,
 will also be transmitted by the model.
\layout Subsection

Multiple Compilation and Synthesis
\layout Standard

Ethernet devices were compiled and simulated with two common simulation
 environments, Modeltech Modelsim and Cadence Logic Verification.
 Ethernet devices were compiled and synthesized with Xilinx Synthesis Technology
 (XST) and Synplicity Synplify Pro.
 By testing code in a large number of different tools, non-portable VHDL
 constructs have been identified and removed, as well as most code constructs
 which cause warnings in any of the tools used.
\layout Subsection

Packet monitoring with The Ethereal Network Analyzer
\layout Standard

The Ethereal Network Analyzer (
\begin_inset Quotes eld
\end_inset 

Ethereal
\begin_inset Quotes erd
\end_inset 

) was used to capture Ethernet packets, efficiently monitoring network conversat
ions between the Test PC and the Ethernet peripheral.
 Ethereal tests were usually performed in a simple network consisting of
 a Test PC, a network switch and a prototype board (with an FPGA configured
 with a MicroBlaze platform).
 This setup is shown in figure 
\begin_inset LatexCommand \ref{cap:Network-Test-Setup}

\end_inset 

.
 
\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:Network-Test-Setup}

\end_inset 

Network Test Setup
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/testsetup1.eps
	display default
	size_type 2
	scale 50
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 


\layout Standard

Ethereal efficiently detected several types of bad layer 3 packets.
 This proved useful for tracking software errors.
\layout Standard

The switch and the Ethernet peripheral on the Test PC drop bad Ethernet
 packets, without showing them to Ethereal.
 Peripheral errors usually cause bad Ethernet packets.
 Because bad Ethernet packets are dropped, Ethereal was not very useful
 for detecting errors in the peripheral.
\layout Subsection

Real World Tests
\layout Standard

To verify hardware robustness, the Ethernet devices were used in a number
 of real world tests.
 Some of them, such as a simple ICMP Echo Request / ICMP Echo Reply test
\begin_inset Foot
collapsed false

\layout Standard

Commonly referred to as 
\begin_inset Quotes eld
\end_inset 

ICMP ping
\begin_inset Quotes erd
\end_inset 

 and performed by the command line tool 
\begin_inset Quotes eld
\end_inset 

ping
\begin_inset Quotes erd
\end_inset 

 which is included in most operating systems.
\end_inset 

, were performed for several hours with no packet loss.
 All real world tests indicates that the final designs are robust.
\layout Chapter


\begin_inset LatexCommand \label{cha:Comparing-Ethernet-peripherals}

\end_inset 

Comparing Ethernet peripherals
\layout Standard

Comparing peripherals is hard.
 Feature requirements, area requirements and system clock requirements may
 be different for each SoC project.
 A SoC is also likely to have high quality requirements, but quality is
 hard to measure.
\layout Standard

Given all these factors, it is not feasible to name a single peripheral
 which is optimal for all applications.
 However it is possible to compare peripherals and determine which is best
 suited for certain applications.
\layout Standard

A number of Ethernet peripherals have been compared: EMAC Lite - Xilinx
 OPB Ethernet Lite Media Access Controller, EMAC - Xilinx OPB Ethernet Media
 Access Controller, EthMac - Opencores.org 10/100 Ethernet MAC, Eth Version
 1.00 Revision A and Eth Version 1.00 Revision C.
\layout Paragraph

EthMac and WISHBONE.
\layout Standard

WISHBONE is a simple bus standard maintained by opencores.org.
 WISHBONE and OPB is similar, both are intended to be an easy to use System
 on Chip bus.
 EthMac is an WISHBONE peripheral.
 MicroBlaze cannot use it because MicroBlaze does not support the WISHBONE
 bus.
 EthMac has been included because it is a well verified MAC, has been used
 in real world applications, and is open source.
 EthMac could probably be converted into an OPB peripheral with some effort.
\layout Section

Feature comparison
\layout Standard

The following set of features has been compared in table 
\begin_inset LatexCommand \ref{cap:Ethernet-peripherals-feature}

\end_inset 

:
\layout Itemize

Asynchronous - does the peripheral make use of MII/RMII clock signals to
 clock flipflops/registers? This is often used to reach 100 MBit/s while
 maintaining low system clock requirements.
 But it has a major drawback: In several FPGAs, you only have a few clock
 input nets.
 Utilizing MII/RMII clocks in a peripheral may limit the application to
 a single Ethernet peripheral.
\layout Itemize

System bus.
 OPB is preferred since it is the only native peripheral bus in MicroBlaze.
\layout Itemize

DMA.
 Is the peripheral able to do direct memory access? This is important to
 make high performance applications.
\layout Itemize

MII Management.
 Is the peripheral able to read/write MII Management registers?
\layout Itemize

PAUSE frame support.
 This is an important Ethernet standard which prevents network congestion.
 If not supported in hardware, it should be supported in the software/drivers.
\layout Itemize

RMII support.
 RMII is a pin-reduced MII-similar interface, preferred in multi-interface/perip
herals designs such as switches.
\layout Standard

The only RMII peripherals are Eth Version 1.00 Revision A and C.
 This is a major advantage in multi-interface designs.
 EMAC, EMAC Lite and Eth Version 1.00 Revision A are synchronous designs.
 This gives them further advantage in multi-interface designs since they
 do not utilize additional clock nets (which are scarce in some FPGA such
 as Xilinx Virtex).
\layout Standard

The peripherals can be divided into a simple peripherals and advanced peripheral
s.
 EMAC and EthMac support a large set of features (DMA, MII Management, PAUSE
 frames) while the others does not.
 Therefor peripherals such as EMAC and EthMac are preferable if an application
 require a full scale DMA-capable interface.
 Peripherals such as EMAC Lite and Eth Version 1.00 Revision A and C are
 preferable if only a simple peripheral is required.
 
\begin_inset Float table
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:Ethernet-peripherals-feature}

\end_inset 

Ethernet peripherals feature comparison
\layout Standard
\align center 

\begin_inset  Tabular
<lyxtabular version="3" rows="6" columns="7">
<features>
<column alignment="left" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" rightline="true" width="0pt">
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Device
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Async
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Bus
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

DMA
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Mgt
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Pause
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

RMII
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

EMAC Lite
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

OPB
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

EMAC
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

OPB
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Yes
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Yes
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Yes
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

EthMac
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Yes
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

WB
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Yes
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Yes
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Yes
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Eth v1.00 A
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

OPB
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Yes
\end_inset 
</cell>
</row>
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Eth v1.00 C
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Yes
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

OPB
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

No
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Yes
\end_inset 
</cell>
</row>
</lyxtabular>

\end_inset 

 
\layout Standard
\align center 

\begin_inset  Tabular
<lyxtabular version="3" rows="5" columns="2">
<features>
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="left" valignment="top" leftline="true" rightline="true" width="0pt">
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Header/Note
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Description / Explanation
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Async
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Asynchronous; utilize MII/RMII clocks to trigger flipflops
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Mgt
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

MII Management interface support
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Pause
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Ethernet full duplex PAUSE frame support
\end_inset 
</cell>
</row>
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

RMII
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Reduced MII interface support
\end_inset 
</cell>
</row>
</lyxtabular>

\end_inset 


\end_inset 


\layout Section


\begin_inset LatexCommand \label{sec:Speed-comparison}

\end_inset 

Speed comparison
\layout Standard

Speed comparison was based on estimated performance for Xilinx Virtex-E
 FPGA (chip xsv2000e-8-FG1156) implementations.
 One reason for using this particular FPGA is that the Platinum prototype
 board which was supposed to be available for the evaluation was Virtex-E
 based.
 Another reason is that speed/area statistics for this particular FPGA is
 included in EMAC / EMAC Lite documentation.
\layout Standard


\begin_inset Formula $f_{max}$
\end_inset 

 is the estimated maximum system clock frequency.
 For configurable designs (such as EMAC / EMAC Lite), the greatest value
 for 
\begin_inset Formula $f_{max}$
\end_inset 

 is listed.
 For Eth v1.00 Revision A and C, MII configuration is used.
\layout Standard


\begin_inset Formula $f_{max}$
\end_inset 

 was estimated by synthesizing the design with XST (optimization level 2
 and optimization mode 
\begin_inset Quotes eld
\end_inset 

speed
\begin_inset Quotes erd
\end_inset 

).
 Then the netlist is passed through the Xilinx Place & Route flow (overall
 effort set to 5, extra effort set to 2) utilizing a set of Ethernet timing
 constraints (table 
\begin_inset LatexCommand \ref{cap:Ethernet-timing-constraints}

\end_inset 

) used by Xilinx in EMAC documentation.
 The system clock period constraint was tweaked until a minimum period was
 found for which all constraints were met.
\layout Standard

Then 
\begin_inset Formula $f_{max}$
\end_inset 

 was calculated as 
\begin_inset Formula $f_{max}=\frac{1000}{system\, clock\, period\, (nanoseconds)}$
\end_inset 

 MHz.
\layout Standard

Table 
\begin_inset LatexCommand \ref{cap:System-clock-and-reset-constraints}

\end_inset 

 illustrates a 133 MHz system clock constraint.
\layout Standard

For EMAC and EMAC Lite, the corresponding values are extracted from the
 specification.
\layout Standard

The results are shown in table 
\begin_inset LatexCommand \ref{cap:Ethernet-peripherals-performance}

\end_inset 

.
 
\begin_inset Float table
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:Ethernet-timing-constraints}

\end_inset 

Ethernet timing constraints
\layout LyX-Code

NET "rx_clk" TNM_NET = "RXCLK_GRP"; 
\layout LyX-Code

NET "tx_clk" TNM_NET = "TXCLK_GRP"; 
\layout LyX-Code

TIMESPEC "TSTXOUT" = FROM "TXCLK_GRP" TO "PADS" 10 ns; 
\layout LyX-Code

TIMESPEC "TSRXIN" = FROM "PADS" TO "RXCLK_GRP" 6 ns;
\layout LyX-Code

NET "rx_clk" USELOWSKEWLINES;
\layout LyX-Code

NET "tx_clk" USELOWSKEWLINES; 
\layout LyX-Code

NET "tx_clk" MAXSKEW= 2.0 ns; 
\layout LyX-Code

NET "rx_clk" MAXSKEW= 2.0 ns; 
\layout LyX-Code

NET "rx_clk" PERIOD = 40 ns HIGH 14 ns; 
\layout LyX-Code

NET "tx_clk" PERIOD = 40 ns HIGH 14 ns; 
\layout LyX-Code

NET "rx_d<3>" NODELAY; 
\layout LyX-Code

NET "rx_d<2>" NODELAY; 
\layout LyX-Code

NET "rx_d<1>" NODELAY; 
\layout LyX-Code

NET "rx_d<0>" NODELAY; 
\layout LyX-Code

NET "rx_dv" NODELAY; 
\end_inset 

 
\begin_inset Float table
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:System-clock-and-reset-constraints}

\end_inset 

System clock and reset constraints
\layout LyX-Code

NET "opb_clk" TNM_NET = "opb_clk"; 
\layout LyX-Code

TIMESPEC "TS_opb_clk" = PERIOD "opb_clk" 7.5 ns HIGH 50 %;
\layout LyX-Code

NET "opb_rst" TIG; 
\end_inset 

 
\begin_inset Float table
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:Ethernet-peripherals-performance}

\end_inset 

Ethernet peripherals performance comparison
\layout Standard
\align center 

\begin_inset  Tabular
<lyxtabular version="3" rows="8" columns="6">
<features>
<column alignment="left" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" rightline="true" width="0pt">
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

\end_inset 
</cell>
<cell multicolumn="1" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard


\begin_inset Formula $f_{min}$
\end_inset 


\end_inset 
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

\end_inset 
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

\end_inset 
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

\end_inset 
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

\end_inset 
</cell>
<cell multicolumn="1" alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

MII
\end_inset 
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

\end_inset 
</cell>
<cell multicolumn="1" alignment="center" valignment="top" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

RMII
\end_inset 
</cell>
<cell multicolumn="2" alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

\end_inset 
</cell>
</row>
<row bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Device
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

10 MBit
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

100 MBit
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

10 MBit
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

100 MBit
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard


\begin_inset Formula $f_{max}$
\end_inset 


\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

EMAC Lite
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

5 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

50 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

N/A
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

N/A
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

80.8 MHz
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

EMAC
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

5 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

50 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

N/A
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

N/A
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

88.0 MHz
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

EthMac
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

?
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

?
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

N/A
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

N/A
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

76.9 MHz
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Eth v1.00 A
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

12.5 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

125 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

25 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

N/A
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

137 MHz
\end_inset 
</cell>
</row>
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Eth v1.00 C
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

3.1 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

31 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

6.2 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

62 MHz
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

137 MHz
\end_inset 
</cell>
</row>
</lyxtabular>

\end_inset 


\layout Standard
\align center 

\begin_inset  Tabular
<lyxtabular version="3" rows="4" columns="2">
<features>
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="left" valignment="top" leftline="true" rightline="true" width="0pt">
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Header/Note
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Description / Explanation
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard


\begin_inset Formula $f_{min}$
\end_inset 


\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Minimum system clock frequency
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard


\begin_inset Formula $f_{max}$
\end_inset 


\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard

Maximum system clock frequency
\end_inset 
</cell>
</row>
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard


\begin_inset Formula $?$
\end_inset 


\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\layout Standard


\begin_inset Formula $f_{min}$
\end_inset 

 has not been researched by EthMac developers
\end_inset 
</cell>
</row>
</lyxtabular>

\end_inset 


\end_inset 


\layout Section

Resource comparison
\layout Standard

Resource comparison was performed for Xilinx Virtex-E FPGA (chip xsv2000e-8-FG11
56) implementations.
 Virtex-E was selected for the same reasons as stated in section 
\begin_inset LatexCommand \ref{sec:Speed-comparison}

\end_inset 

 (Speed Comparison).
\layout Standard

Virtex-E has three major resources which is used by the Ethernet peripherals:
\layout Paragraph

Slices
\layout Standard

are the main Virtex-E resource.
 These are blocks of programmable logic.
 Most things are implemented in slices.
 Table 
\begin_inset LatexCommand \ref{cap:Ethernet-peripherals-area}

\end_inset 

 shows that all simple MACs consume few slices (350 - 470) while advanced
 MACs consume a few thousand slices.
\layout Paragraph

BRAM (Block Select RAM)
\layout Standard

are memory blocks in which data can be stored efficiently.
 Table 
\begin_inset LatexCommand \ref{cap:Ethernet-peripherals-area}

\end_inset 

 shows that EthMac utilize less BRAM resources than other MACs in test.
\layout Paragraph

GCLK (Global Clock Nets)
\layout Standard

are routing nets which provide clock signals to logic (e.g.
 slices and BRAM).
 This is a scarce resource: Virtex-E have only four GCLKs.
 Table 
\begin_inset LatexCommand \ref{cap:Ethernet-peripherals-area}

\end_inset 

 shows that all synchronous MACs in the test utilize one GCLK (system clock).
 All asynchronous MACs used in test utilize three GCLKs (System, transmit
 and receive clocks).
 
\begin_inset Float table
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:Ethernet-peripherals-area}

\end_inset 

Ethernet peripherals area comparison
\layout Standard
\align center 

\begin_inset  Tabular
<lyxtabular version="3" rows="6" columns="4">
<features>
<column alignment="left" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" width="0pt">
<column alignment="center" valignment="top" leftline="true" rightline="true" width="0pt">
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Device
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Slices
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

BRAM
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

GCLK
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

EMAC Lite
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

350 - 405
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

8 (4KB)
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

1
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

EMAC
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

1528 - 2570
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

8 - 16 (4 - 8KB)
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

1
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

EthMac
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

2439
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

2 (1KB)
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

3
\end_inset 
</cell>
</row>
<row topline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Eth v1.00 A
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

370
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

8 (4KB)
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

1
\end_inset 
</cell>
</row>
<row topline="true" bottomline="true">
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

Eth v1.00 C
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

476
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

8 (4KB)
\end_inset 
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\layout Standard

3
\end_inset 
</cell>
</row>
</lyxtabular>

\end_inset 


\end_inset 


\layout Section

Quality comparison
\layout Standard

EMAC Lite and EMAC is considered production quality by the Xilinx corporation.
 EthMac is considered production quality by the opencores.org developers.
 These three MACs have been tested by developers as well as number of users/cust
omers.
 Therefor, they are by far the most well verified peripherals.
\layout Standard

Eth Version 1.00 Revision A and C are not as well verified.
 
\layout Standard

The Eth Version 1.00 revisions has been reused by a small number of students.
 Eth has also passed a number of verification tests.
 The Eth 1.00 revisions are therefor considered to be of good academic quality
 but more tests are needed before they can be considered to be of production
 quality.
 
\layout Section

Details about the devices used in analysis
\layout Subsection

EMAC Lite - Xilinx OPB Ethernet Lite Media Access Controller
\layout Standard

EMAC Lite is a simple Ethernet MAC provided by Xilinx.
 It is an OPB device and easily used in MicroBlaze applications.
 It is marketed as a simpler and smaller device than EMAC.
\layout Standard

Features:
\layout Itemize

10/100 MBit/s, MII only.
\layout Itemize

Minimum system clock frequency is 5 MHz (50 MHz for 100 MBit/s).
\layout Itemize

Synchronous.
\layout Itemize

Not runtime configurable, e.g.
 duplex mode is configured at build time.
\layout Itemize

No promiscuous mode.
\layout Itemize

Small 2*2KB packet FIFOs, one packet per FIFO only.
\layout Subsection

EMAC - Xilinx OPB Ethernet Media Access Controller
\layout Standard

EMAC is an advanced and full-featured MAC provided by Xilinx.
 It is an OPB device and easily used in MicroBlaze applications.
 It has features which enables great performance (such as DMA and multiple
 packets per FIFO) and useful options (MII Management, autopad, promiscuous
 mode).
\layout Standard

Features:
\layout Itemize

10/100 MBit/s, MII only.
\layout Itemize

Minimum system clock frequency is 5 MHz (50 MHz for 100 MBit/s).
\layout Itemize

Synchronous.
\layout Itemize

MII Management module.
\layout Itemize

Small 2*2KB or 2*4KB FIFOs, up to 16 packets per FIFO.
\layout Itemize

Pause frame support.
\layout Itemize

DMA or FIFO-registers for I/O.
\layout Itemize

Autopad short packages.
\layout Itemize

Promiscuous mode runtime configurable.
 
\layout Subsection

EthMac - Opencores.org 10/100 Ethernet MAC
\layout Standard

EthMac is an advanced and full featured MAC developed in the Open Source
 community Opencores.org.
 EthMac uses a WISHBONE data bus for I/O.
\layout Standard

Features:
\layout Itemize

10/100 MBit/s, MII only.
\layout Itemize

Minimum system clock frequency unspecified
\begin_inset Foot
collapsed false

\layout Standard

EthMac developers have focused on achieving great clock frequencies.
 Since low clock frequency have not been a design concerned, this has not
 been researched by EthMac developers.
\end_inset 

.
\layout Itemize

Asynchronous.
\layout Itemize

Pause frame support.
\layout Itemize

DMA or FIFO registers for I/O.
\layout Itemize

Autopad short packages.
\layout Itemize

Promiscuous mode runtime configurable.
\layout Chapter


\begin_inset LatexCommand \label{cha:Network-software-for-Microblaze}

\end_inset 

Network software for MicroBlaze
\layout Section

Small TCP/IP stacks for embedded applications
\layout Standard

In the context of small TCP/IP stacks, it is interesting to know 
\begin_inset Quotes eld
\end_inset 

how small is a small TCP/IP stack?
\begin_inset Quotes erd
\end_inset 

.
 The answer is simple - it depends on what you are comparing with regard
 to.
 Some application specific stacks may only contain 256 bytes of code, but
 a general stack is hard to make that small.
\layout Standard

Therefore, we define a number of characteristics preferred in a small TCP/IP
 stack for MicroBlaze:
\layout Itemize

The stack should be general and reusable, not designed for a single application.
\layout Itemize

The TCP/IP stack should provide two buffers: one for receiving and one for
 sending packets.
 These buffers may be as small as a single packet.
 These buffers enable simple interfaces for handling datagram oriented stacks
 (ARP, ICMP, UDP and others).
 These buffers may be reused by all datagram functions to save memory.
\layout Itemize

The stack should not be multi-user oriented
\begin_inset Foot
collapsed false

\layout Standard

There are usually no user (or a single user) in SoCs and embedded applications.
 Providing memory protection and multi-user handling is memory expensive
 and serves no purpose in this context.
\end_inset 

.
\layout Itemize

The stack should be modular.
 If an application only need ARP+UDP, or ARP+ICMP, it should not be required
 to implement memory expensive protocols such as TCP.
\layout Itemize

The stack should be available as well commented/documented source code
\begin_inset Foot
collapsed false

\layout Standard

Because developers may wish to tweak the stack for a specific application.
\end_inset 

.
 
\layout Subsection

Xilinx XilNet
\layout Standard

Xilinx XilNet is a small TCP/IP stack included in MDK.
 It is provided to demonstrate the networking capabilities of MicroBlaze.
 However XilNet suffers a number of drawbacks:
\layout Itemize

No network peripheral is included in MicroBlaze, so it is not possible to
 use XilNet with MDK peripherals only.
\layout Itemize

The requirements on MAC send/receive functions are unspecified.
 No example of such functions is provided for reference.
\layout Itemize

No example applications utilizing XilNet are provided.
\layout Itemize

XilNet is unsupported (as opposed to all other MDK libraries).
\layout Itemize

XilNet documentation is of low quality and only describes the function calls.
 No usage notes nor general design description is provided.
\layout Subsubsection

Several issues with XilNet
\layout Standard

Attempts were made to make XilNet work.
 The XilNet implementation used is described in Appendix 
\begin_inset LatexCommand \ref{cha:XilNet-implementation-for-eth}

\end_inset 

.
 MAC functions were easily implemented.
 
\layout Standard

ARP was successfully tested but IPv4/ICMP tests failed.
 XilNet was able to receive ICMP Echo Request packets, but the following
 errors were observed on the corresponding ICMP Echo Reply packets:
\layout Itemize

IPv4 checksum was incorrect.
\layout Itemize

IPv4 total length was incorrect.
\layout Itemize

ICMP checksum was incorrect.
\layout Itemize

ICMP data was incorrect.
\layout Standard

These errors may be due to incorrect implementation / usage of XilNet or
 a flaw in XilNet itself.
 Xilinx Embedded Processor Forum was searched for a solution, but no relevant
 information was found.
 The forum indicates that there are issues 
\begin_inset LatexCommand \cite{XPEF-XilNet1,XPEF-XilNet2}

\end_inset 

 even with recent XilNet versions included in EDK.
\layout Subsubsection

Modularity
\layout Standard

XilNet has a modular design at file level (
\emph on 
arp.c
\emph default 
, 
\emph on 
ip.
\emph default 
c, 
\emph on 
tcp.c
\emph default 
 etc).
 However there are several interdependencies, especially in the file 
\emph on 
ip.c
\emph default 
.
 A number of changes to ip.c (mainly preprocessor directives such as 
\emph on 
#ifdef
\emph default 
 and 
\emph on 
#endif
\emph default 
) were applied and XilNet was successfully stripped of TCP support to save
 memory.
\layout Subsubsection

Functionality
\layout Standard

XilNet's TCP support is limited.
 It supports only a single concurrent TCP connection.
\layout Subsubsection

Overall
\layout Standard

XilNet is a very small TCP/IP stack.
 XilNet is 8 KB large, but a small test-application (appendix 
\begin_inset LatexCommand \ref{cha:XilNet-implementation-for-eth}

\end_inset 

) with XilNet but without TCP and UDP support is only 5 KB large.
 This makes XilNet well suited for applications with very little RAM.
 However, several users have experienced problems using XilNet.
\layout Subsection

lwIP
\layout Standard

lwIP is described by 
\begin_inset LatexCommand \cite{lwIP}

\end_inset 

 as:
\layout Quotation

The focus of the lwIP TCP/IP implementation is to reduce the RAM usage while
 still having a full scale TCP.
 This makes lwIP suitable for use in embedded systems with tens of kilobytes
 of free RAM and room for around 40 kilobytes of code ROM.
 
\layout Standard

lwIP was ported to MicroBlaze by Nilsson, Schmid and Wiklander.
 The MicroBlaze port is known as MB-lwIP 
\begin_inset LatexCommand \cite{MB-lwIP}

\end_inset 

.
\layout Subsubsection

Modularity
\layout Standard

lwIP is of a modular design.
 Its is made to be easy to port and to add new network interface drivers.
\layout Subsubsection

Functionality
\layout Standard

lwIP is a full scale TCP/IP stack.
\layout Subsubsection

Overall
\layout Standard

lwIP uses 40 KB RAM, which is a lot in (low cost) SoC applications.
 Either the SoC contains more than 40 KB of internal RAM, or external memory
 must be used.
\layout Section

Operating Systems for MicroBlaze
\layout Standard

A number of real-time and micro controller operating systems are ported
 to MicroBlaze, e.g:
\layout Itemize

Micrium 
\begin_inset Formula $\mu $
\end_inset 

C/OS-II
\layout Itemize

ATI Nucleus
\layout Itemize


\begin_inset Formula $\mu $
\end_inset 

CLinux
\layout Standard

Notably is RealFast 
\begin_inset LatexCommand \cite{RealFast-Sierra16}

\end_inset 

 Sierra 16 HW-RTOS (hardware real-time operating systems) support for MicroBlaze.
 Sierra 16 and MicroBlaze may be implemented in a single Xilinx FPGA.
 RealFast's vision is to relieve micro controllers of time consuming software
 tasks by providing dedicated hardware such as Sierra 16 HW-RTOS.
\layout Chapter


\begin_inset LatexCommand \label{cha:Results}

\end_inset 

Results
\layout Standard

In chapter 
\begin_inset LatexCommand \ref{cha:Introduction}

\end_inset 

 a set of objectives were identified.
 This chapter states how they were met.
\layout Paragraph

Xilinx MicroBlaze and the IBM CoreConnect On-Chip Peripheral Bus
\layout Standard

were evaluated.
 They were shown to provide a powerful RISC architecture with good bus performan
ce.
 The bus enables a large number of network peripherals even at low system
 frequencies.
\layout Paragraph

The MDK standard peripherals
\layout Standard

were evaluated.
 They are concluded to be a small set of simple peripherals which are useful
 in several applications.
 A greater set of peripherals, e.g.
 network peripherals and bus bridges, would have made MDK much more complete.
\layout Paragraph

The MDK software development tools
\layout Standard

proved to be easy to use - partially thanks to their similarities with standard
 UNIX tools.
 MicroBlaze software development is usually simple and straight-forward
 programming in the C language.
 The GNU Debugger (GDB) allows remote on-chip debugging which is useful.
\layout Paragraph

The MDK platform tailoring tools
\layout Standard

were evaluated.
 They are adequate for simple platforms.
 Some problems became apparent in more complex designs.
\layout Paragraph

Network connectivity
\layout Standard

has been provided through the Eth Version 1.00 set of peripherals which were
 designed in this thesis work.
 A number of different customizations of Eth have been demonstrated.
 MII and RMII are supported in all customizations and MII has been verified
 on prototyping boards.
 RMII capabilities could only be verified in simulations.
\layout Paragraph

Ethernet peripherals
\layout Standard

have been analyzed.
 Because each peripheral has a unique set of features and drawbacks, no
 peripheral can be selected to be considered the best.
 Eth Version 1.00 performed especially well in performance benchmarks, while
 other peripherals were concluded to support more features and to be better
 verified.
\layout Paragraph

Xilinx XilNet
\layout Standard

TCP/IP stack was evaluated.
 A number of problems were identified.
 It was determined that several developers in the 
\emph on 
Xilinx Embedded Processor Forum
\emph default 
 various experienced problems with XilNet.
\layout Paragraph

lwIP
\layout Standard

was evaluated for MicroBlaze.
 
\begin_inset LatexCommand \cite{MB-lwIP}

\end_inset 

 demonstrated a lwIP based web-server running on MicroBlaze.
\layout Chapter


\begin_inset LatexCommand \label{cha:Discussion}

\end_inset 

Discussion
\layout Standard

Xilinx MicroBlaze is one among several new soft core processors.
 Several soft core processors are emerging from commercial manufacturers,
 academic institutions and open source communities.
\layout Standard

This thesis has not attempted to compare MicroBlaze to the broad range of
 soft core processors.
 Xilinx market MicroBlaze as 
\begin_inset Quotes eld
\end_inset 

the industry's fastest soft processing solution
\begin_inset Quotes erd
\end_inset 

 
\begin_inset LatexCommand \cite{MicroBlaze_WWW}

\end_inset 

, so MicroBlaze is likely to perform well in performance evaluations.
\layout Standard

When this thesis work set out, the overall goal was to evaluate Xilinx MicroBlaz
e for Network applications.
 A number of key objectives for reaching this goal were identified in chapter
 
\begin_inset LatexCommand \ref{cha:Introduction}

\end_inset 

.
 These objectives have all been met.
\layout Paragraph*

No multi-interface prototyping board.
\layout Standard

An important setback was that the Platinum prototyping board did not become
 available during the work on this thesis due to development and manufacturing
 problems.
 Because Platinum was not available, RMII capabilities of the network peripheral
 Eth could not be verified.
 A large set of applications which requires several network interfaces could
 not be demonstrated without the Platinum prototyping board.
\layout Standard

This setback did not have a major impact to the evaluation, but a number
 of simple 
\begin_inset Quotes eld
\end_inset 

proof of concept
\begin_inset Quotes erd
\end_inset 

 multi-interface applications, such as network switches, could not be implemente
d.
\layout Section

Future work
\layout Paragraph

Embedded Development Kit (EDK)
\layout Standard

was not used in this evaluation.
 All experiments have been performed using the MDK environment.
 A re-evaluation using EDK would be useful.
 EDK might remedy the problems found in the MDK platform tailoring utilities.
\layout Paragraph

XilNet
\layout Standard

sent bad IP and ICMP packets in this evaluation.
 The cause of bad packets is not known.
 Making XilNet send correct packets would be useful.
 More recent versions of XilNet included in EDK could be evaluated.
\layout Paragraph

Soft core processor comparison.
\layout Standard

An overview of the soft core processors available would be interesting.
 Without an independent review of a large set of processors, engineers will
 have a hard time finding out which processor is best suited for their applicati
on.
\layout Paragraph

The OpenCores.org 10/100 Ethernet MAC
\layout Standard

is well verified and has been used by a large set of developers.
 It has been used in professional projects.
 This MAC is therefor of production quality and is available for free (GPL
 
\begin_inset Quotes eld
\end_inset 

copyleft
\begin_inset Quotes erd
\end_inset 

 open source license).
\layout Standard

The MAC uses the WISHBONE as its system bus.
 It would be interesting to port this MAC to Xilinx OPB.
 A port may be of interest to developers with limited funding or with previous
 experience of this MAC.
\layout Standard

There are at least two ways to port the WISHBONE MAC:
\layout Itemize

Rewrite the top module (and some of the components) for Xilinx OPB.
\layout Itemize

Create a WISHBONE 
\begin_inset Formula $\Leftrightarrow $
\end_inset 

 OPB bridge for the MAC to use.
\layout Standard

The later approach may be much more beneficial because then the port would
 not break upon changes in the OpenCores MAC source code.
 It may also be simpler, as it require only basic understanding of WISHBONE
 and OPB.
 The 
\begin_inset Quotes eld
\end_inset 

OPB Usage Notes
\begin_inset Quotes erd
\end_inset 

 
\begin_inset LatexCommand \cite{MB_HWREF}

\end_inset 

 provided by Xilinx, intended to aid bridging Xilinx OPB with other OPB
 implementations, might also be used in the development of such a bridge.
\layout Paragraph

Adding features to Eth Version 1.00 revisions.
\layout Standard

The Eth 1.00 revisions are simple Ethernet peripherals and can be extended
 with several features.
 Some new features might include:
\layout Itemize

Half Duplex (CSMA/CD) support, non-promiscuous mode, MII Management and
 PAUSE frame support
\layout Paragraph

Utilizing more clock edges in Eth Version 1.00.
\layout Standard

Revision A is single edge triggered and synchronous.
 Revision C is asynchronous and all flipflops are triggered by rising edge.
 Minimum Clock frequency and power dissipation may be reduced by utilizing
 both edges.
 This is most likely performed in other peripherals (e.g.
 Xilinx EMAC) which synchronously detect MII rising edges at half the frequency
 of Eth Revision A.
\layout Paragraph

Independent and professional verification of Eth Version 1.00.
\layout Standard

Eth would benefit from an independent and professional verification.
 As of current date it has been reused, modified and verified in a few student
 projects.
 But student project tend to keep loose quality standards.
 Professional engineers would not consider Eth to be of production quality.
\layout Paragraph

More interesting proof-of-concept applications.
\layout Standard

Implementing a network switch or other multi-interface design would be nice.
 With access to a multi-interface FPGA prototyping board, this should be
 easy.
\layout Section

Conclusions
\layout Paragraph

Processor core and architecture.
\layout Standard

Xilinx MicroBlaze is a powerful soft core processor well suited for Network
 SoC design.
 The IBM CoreConnect On-Chip Peripheral Bus provides a simple and fast interface
 to MicroBlaze peripherals.
 
\layout Paragraph

Software.
\layout Standard

A large set of software is available or can be ported to Xilinx MicroBlaze.
 A small number of operating systems are already available to MicroBlaze.
 TCP/IP stacks for embedded applications, such as lwIP, are easily ported
 to MicroBlaze.
 
\layout Paragraph

Development kits for MicroBlaze.
\layout Standard

The MicroBlaze Development Kit (MDK) gives a good overall impression and
 is easy to use.
 Some issues with MDK have been found, but the Embedded Development Kit
 (EDK) is believed to remedy at least one of them.
\layout Bibliography
\bibitem [ETHERNET]{Book-Gigabit-Ethernet}

Jayant Kadambi, Ian Crayford, Mohan Kalkunte.
\newline 

\emph on 
Gigabit Ethernet - Migrating to High-Bandwidth LANs
\emph default 
.
 
\newline 
Prentice Hall, 1998.
 ISBN 0-13-913286-4
\layout Bibliography
\bibitem [IBM1]{CoreConnect_WhitePaper}


\emph on 
The CoreConnect
\begin_inset ERT
status Collapsed

\layout Standard

\backslash 
texttrademark
\end_inset 

 Bus Architecture (White Paper)
\emph default 

\newline 
International Business Machines Corporation (IBM), 1999.
\newline 

\emph on 
http://www.chips.ibm.com/products/coreconnect/
\layout Bibliography
\bibitem [VIRTEX]{VIRTEX}


\emph on 
Virtex
\emph default 

\begin_inset ERT
status Collapsed

\layout Standard

\backslash 
texttrademark
\end_inset 


\emph on 
 2.5 V Field Programmable Gate Arrays
\emph default 

\newline 
Xilinx Inc., 2002.
\layout Bibliography
\bibitem [XMB1]{MB_HWREF}


\emph on 
MicroBlaze
\begin_inset ERT
status Collapsed

\layout Standard

\backslash 
texttrademark
\end_inset 

 Hardware Reference Guide (version 2.2)
\emph default 
.
\newline 
Xilinx Inc., 2002.
 
\layout Bibliography
\bibitem [XMB2]{MB_SWREF}


\emph on 
MicroBlaze
\begin_inset ERT
status Collapsed

\layout Standard

\backslash 
texttrademark
\end_inset 

 Software Reference Guide (version 2.2)
\emph default 
.
\newline 
Xilinx Inc, 2002.
\layout Bibliography
\bibitem [XMB3]{MB_TUTORIAL}


\emph on 
MicroBlaze Development Kit Tutorial (version 2.2).
\emph default 

\newline 
Xilinx Inc, 2002.
\layout Bibliography
\bibitem [XMB4]{MB_OPB_TUTORIAL}


\emph on 
Designing Custom OPB Slave Peripherals for MicroBlaze (version 2.2).
\emph default 

\newline 
Xilinx Inc, 2002.
\layout Bibliography
\bibitem [XMB5]{MicroBlaze_WWW}


\emph on 
MicroBlaze Soft Processor
\emph default 
.
\newline 
Xilinx Inc, 2002.
\newline 
4th November 2003.
 
\emph on 
http://www.xilinx.com/xlnx/xil_prodcat_product.jsp?title=microblaze
\layout Bibliography
\bibitem [XAPP632]{XAPP632_Programming_via_E-Mail}

Marc Defossez.
\newline 
Programming an FPGA via E-Mail.
\newline 
In 
\emph on 
Xilinx Application Note 632 (v 1.0)
\emph default 
, 2002.
\layout Bibliography
\bibitem [XTE1]{XTE-Asynchronous}

Peter Alfke.
\newline 
Moving Data Across Asynchronous Clock Boundaries
\newline 
In 
\emph on 
Xilinx techXclusives
\emph default 
, 2001.
\layout Bibliography
\bibitem [XEPF1]{XEPF-Platgen-OPB-Limitation}

Mathew Oullette et al.
 
\newline 
Platgen: OPB Limitation
\newline 
In 
\emph on 
Xilinx Embedded Processor Forum
\emph default 
, 2002.
\layout Bibliography
\bibitem [XPEF2]{XPEF-XilNet1}

Brett Boren et al.
\newline 
Xilnet: more meaningful examples please.
\newline 
In 
\emph on 
Xilinx Embedded Processor Forum
\emph default 
, 2003.
\layout Bibliography
\bibitem [XPEF3]{XPEF-XilNet2}

Brett Boren, Trond Kortner et al.
\newline 
XilNet: Incomplete tcp/ip stack.
\newline 
In 
\emph on 
Xilinx Embedded Processor Forum
\emph default 
, 2003.
\layout Bibliography
\bibitem [REALFAST]{RealFast-Sierra16}

Tommy Klevin.
\newline 
Get RealFast RTOS with Xilinx FGPAs.
\newline 
In 
\emph on 
Xilinx Journal
\emph default 
, Spring 2003.
\layout Bibliography
\bibitem [lwIP]{lwIP}

Adam Dunkels.
\newline 

\emph on 
lwIP - A Lightweight TCP/IP Stack
\emph default 
.
\newline 
4th November 2003.
 
\emph on 
http://www.sics.se/~adam/lwip/
\layout Bibliography
\bibitem [MB-lwIP]{MB-lwIP}

Stefan Nilsson, Frederik Schmid, Jimmie Wiklander.
\newline 

\emph on 
MB-lwIP: An lwIP implementation for MicroBlaze.
\emph default 

\newline 
Luleå University of Technology, 2003.
\layout Bibliography
\bibitem [FOLDOC]{FOLDOC}

Denis Howe et.al.
\newline 
FOLDOC - Free On-Line Dictionary of Computing.
\newline 
Imperial Collage Department of Computing.
\newline 
4th November 2003.
 
\emph on 
http://foldoc.doc.ic.ac.uk/foldoc/
\layout Bibliography
\bibitem [FPGACPU]{Site-fpgacpu.org}

FPGA CPU News.
 
\newline 
4th November 2003.
 
\emph on 
http://www.fpgacpu.org/
\layout Bibliography
\bibitem [OPENCORES]{Site-OpenCores}

OPENCORES.ORG.
\newline 
4th November 2003.
 
\emph on 
http://www.opencores.org/
\layout Chapter*

Copyrights & Trademarks
\layout Standard

All products and company names are service marks, trademarks or registered
 trademarks and are the property of their respective owners.
 This thesis include images from copyrighted materials for academic citation
 purposes.
 All images included from copyrighted materials are the property of their
 respective owners.
\layout Standard

Permissions to reprint copyrighted materials owned by Xilinx Inc for this
 thesis have been obtained from Xilinx Inc.
\layout Standard

Permission to reprint copyrighted materials owned by IBM for this thesis
 have been requested.
 (waiting for reply)
\layout Chapter
\start_of_appendix 
Eth Version 1.00 Revision A Schematics
\layout Standard


\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:TX-Core}

\end_inset 

Eth Version 1.00 Revision A, TX Core
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/ethtx-core-hack.eps
	display default
	size_type 1
	width 95text%
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 


\layout Standard


\begin_inset Float figure
wide false
collapsed false

\layout Caption


\begin_inset LatexCommand \label{cap:RX-Core}

\end_inset 

Eth Version 1.00 Revision A, RX Core
\layout Standard
\align center 

\begin_inset Graphics FormatVersion 1
	filename images/ethrx-core-hack.eps
	display default
	size_type 1
	height 70page%
	keepAspectRatio
	rotateOrigin leftBaseline
	lyxsize_type 0

\end_inset 


\end_inset 


\layout Chapter


\begin_inset LatexCommand \label{cha:XilNet-implementation-for-eth}

\end_inset 

XilNet implementation for Eth V 1.00 A
\layout Standard


\begin_inset Float figure
wide false
collapsed false

\layout Caption

XilNet test application
\layout LyX-Code

#define _CONFIG_ETH_
\layout LyX-Code

\layout LyX-Code

#include <eth.h> 
\layout LyX-Code

#include <packet.h> 
\layout LyX-Code

#include <eth_hwdr.h> 
\layout LyX-Code

#include <ip.h> 
\layout LyX-Code

#include <mbio.h>
\layout LyX-Code

\layout LyX-Code

unsigned char protype_board_mac_addr[6] = {0x00,0x00,0x3f,0xde,0xad,0xf0};
\layout LyX-Code

\layout LyX-Code

int main( void ) {
\layout LyX-Code

        int i;
\layout LyX-Code

        xilnet_eth_port_init( protype_board_mac_addr, ETH1_BASEADDR );
\layout LyX-Code

        mb_ip_addr[0] = 130;
\layout LyX-Code

        mb_ip_addr[1] = 240;
\layout LyX-Code

        mb_ip_addr[2] = 2;
\layout LyX-Code

        mb_ip_addr[3] = 24;
\layout LyX-Code

        while (1) { 
\layout LyX-Code

                xilnet_eth_recv_frame( recvbuf, LINK_FRAME_LEN ); 
\layout LyX-Code

        }
\layout LyX-Code

} 
\end_inset 


\layout Standard


\begin_inset Float figure
wide false
collapsed false

\layout Caption

Implementation of xilnet_mac_send_frame()
\layout LyX-Code

void xilnet_mac_send_frame( unsigned char* frame, int len) {
\layout LyX-Code

        unsigned int i, fifo=0;
\layout LyX-Code

        while (! ETH_HWDR_TX_EMPTY(xilnet_base) ) ;
\layout LyX-Code

        
\layout LyX-Code

        for (i=0; i<len; i++) {
\layout LyX-Code

                switch(i&3) {
\layout LyX-Code

                case 0: fifo  = frame[i]<<24; break;
\layout LyX-Code

                case 1: fifo |= frame[i]<<16; break;
\layout LyX-Code

                case 2: fifo |= frame[i]<<8; break;
\layout LyX-Code

                case 3: fifo |= frame[i];
\layout LyX-Code

                         *ETH_HWDR_TX_FIFO(xilnet_base) = fifo;
\layout LyX-Code

                        break;
\layout LyX-Code

                }
\layout LyX-Code

        }
\layout LyX-Code

        if (i&3) *ETH_HWDR_TX_FIFO(xilnet_base) = fifo;
\layout LyX-Code

\layout LyX-Code

        ETH_HWDR_TX_SEND(xilnet_base, len);
\layout LyX-Code

        return ;
\layout LyX-Code

} 
\end_inset 


\layout Standard


\begin_inset Float figure
wide false
collapsed true

\layout Caption

Implementation of xilnet_mac_recv_frame()
\layout LyX-Code

int xilnet_mac_recv_frame ( unsigned char *frame, int len ) {
\layout LyX-Code

        unsigned int fifo=0;
\layout LyX-Code

        int i, length, lengthDiv4, lengthMod4;
\layout LyX-Code

        
\layout LyX-Code

        if (!xilnet_base) return 0;
\layout LyX-Code

\layout LyX-Code

        while ( ! ETH_HWDR_RX_BUFFERED(xilnet_base) ) ;
\layout LyX-Code

\layout LyX-Code

        length = ETH_HWDR_RX_PKT_LENGTH(xilnet_base);
\layout LyX-Code

        length = (length>len) ? len : length ;
\layout LyX-Code

        lengthDiv4 = length >> 2;
\layout LyX-Code

        lengthMod4 = length & 3;
\layout LyX-Code

\layout LyX-Code

        for (i=0; i<lengthDiv4; i++) {
\layout LyX-Code

                fifo = *ETH_HWDR_RX_FIFO(xilnet_base) ;
\layout LyX-Code

                (*frame++) = (fifo>>24) & 0xff;
\layout LyX-Code

                (*frame++) = (fifo>>16) & 0xff;
\layout LyX-Code

                (*frame++) = (fifo>>8) & 0xff;
\layout LyX-Code

                (*frame++) = fifo & 0xff;
\layout LyX-Code

        }
\layout LyX-Code

        if (lengthMod4) fifo = *ETH_HWDR_RX_FIFO(xilnet_base) ;
\layout LyX-Code

                switch(lengthMod4) {
\layout LyX-Code

                case 3:
\layout LyX-Code

                        (*frame++) = (fifo>>24) & 0xff;
\layout LyX-Code

                        (*frame++) = (fifo>>16) & 0xff;
\layout LyX-Code

                        (*frame++) = (fifo>>8) & 0xff;
\layout LyX-Code

                        break;
\layout LyX-Code

                case 2:
\layout LyX-Code

                        (*frame++) = (fifo>>24) & 0xff;
\layout LyX-Code

                        (*frame++) = (fifo>>16) & 0xff;
\layout LyX-Code

                        break;
\layout LyX-Code

                case 1:
\layout LyX-Code

                         (*frame++) = (fifo>>24) & 0xff;
\layout LyX-Code

                         break;
\layout LyX-Code

        }
\layout LyX-Code

        ETH_HWDR_RX_CLEAR_FIFO(xilnet_base);
\layout LyX-Code

        return (length>4) ? (length-4) : 0;
\layout LyX-Code

} 
\end_inset 


\layout Standard


\begin_inset Float figure
wide false
collapsed false

\layout Caption

Etherreal log, ICMP packet from Test PC to XilNet
\layout LyX-Code

Frame 43 (74 bytes on wire, 74 bytes captured)
\layout LyX-Code

    Arrival Time: Jun  2, 2003 12:39:36.893565000
\layout LyX-Code

    Time delta from previous packet: 0.000020000 seconds
\layout LyX-Code

    Time relative to first packet: 9.895098000 seconds
\layout LyX-Code

    Frame Number: 43
\layout LyX-Code

    Packet Length: 74 bytes
\layout LyX-Code

    Capture Length: 74 bytes
\layout LyX-Code

Ethernet II, Src: 00:d0:b7:b3:fc:f6, Dst: 00:00:3f:de:ad:f0
\layout LyX-Code

    Destination: 00:00:3f:de:ad:f0 (Syntrex_de:ad:f0)
\layout LyX-Code

    Source: 00:d0:b7:b3:fc:f6 (Intel_b3:fc:f6)
\layout LyX-Code

    Type: IP (0x0800)
\layout LyX-Code

Internet Protocol, Src Addr: 130.240.35.9 (130.240.35.9),
\layout LyX-Code

                   Dst Addr: 130.240.2.24 (130.240.2.24)
\layout LyX-Code

    Version: 4
\layout LyX-Code

    Header length: 20 bytes
\layout LyX-Code

    Differentiated Services Field: 0x00 (DSCP 0x00: Default; ECN: 0x00)
\layout LyX-Code

        0000 00..
 = Differentiated Services Codepoint: Default (0x00)
\layout LyX-Code

        ....
 ..0.
 = ECN-Capable Transport (ECT): 0
\layout LyX-Code

        ....
 ...0 = ECN-CE: 0
\layout LyX-Code

    Total Length: 60
\layout LyX-Code

    Identification: 0xa7aa
\layout LyX-Code

    Flags: 0x00
\layout LyX-Code

        .0..
 = Don't fragment: Not set
\layout LyX-Code

        ..0.
 = More fragments: Not set
\layout LyX-Code

    Fragment offset: 0
\layout LyX-Code

    Time to live: 32
\layout LyX-Code

    Protocol: ICMP (0x01)
\layout LyX-Code

    Header checksum: 0xc815 (correct)
\layout LyX-Code

    Source: 130.240.35.9 (130.240.35.9)
\layout LyX-Code

    Destination: 130.240.2.24 (130.240.2.24)
\layout LyX-Code

Internet Control Message Protocol
\layout LyX-Code

    Type: 8 (Echo (ping) request)
\layout LyX-Code

    Code: 0
\layout LyX-Code

    Checksum: 0xc256 (correct)
\layout LyX-Code

    Identifier: 0x0100
\layout LyX-Code

    Sequence number: 8a:05
\layout LyX-Code

    Data (32 bytes)
\layout LyX-Code

 
\layout LyX-Code

\layout LyX-Code

0000  61 62 63 64 65 66 67 68 69 6a 6b 6c 6d 6e 6f 70   abcdefghijklmnop
\layout LyX-Code

0010  71 72 73 74 75 76 77 61 62 63 64 65 66 67 68 69   qrstuvwabcdefghi
\layout LyX-Code

\end_inset 


\layout Standard


\begin_inset Float figure
wide false
collapsed false

\layout Caption

Etherreal log, ICMP packet from Xilnet to Test PC
\layout LyX-Code

Frame 44 (82 bytes on wire, 82 bytes captured)
\layout LyX-Code

    Arrival Time: Jun  2, 2003 12:39:36.894029000
\layout LyX-Code

    Time delta from previous packet: 0.000464000 seconds
\layout LyX-Code

    Time relative to first packet: 9.895562000 seconds
\layout LyX-Code

    Frame Number: 44
\layout LyX-Code

    Packet Length: 82 bytes
\layout LyX-Code

    Capture Length: 82 bytes
\layout LyX-Code

Ethernet II, Src: 00:00:3f:de:ad:f0, Dst: 00:d0:b7:b3:fc:f6
\layout LyX-Code

    Destination: 00:d0:b7:b3:fc:f6 (Intel_b3:fc:f6)
\layout LyX-Code

    Source: 00:00:3f:de:ad:f0 (Syntrex_de:ad:f0)
\layout LyX-Code

    Type: IP (0x0800)
\layout LyX-Code

    Trailer: 00000000000000000000000000000000...
 
\layout LyX-Code

Internet Protocol, Src Addr: 130.240.2.24 (130.240.2.24),
\layout LyX-Code

                   Dst Addr: 130.240.35.9 (130.240.35.9)
\layout LyX-Code

    Version: 4
\layout LyX-Code

    Header length: 20 bytes
\layout LyX-Code

    Differentiated Services Field: 0x00 (DSCP 0x00: Default; ECN: 0x00)
\layout LyX-Code

        0000 00..
 = Differentiated Services Codepoint: Default (0x00)
\layout LyX-Code

        ....
 ..0.
 = ECN-Capable Transport (ECT): 0
\layout LyX-Code

        ....
 ...0 = ECN-CE: 0
\layout LyX-Code

    Total Length: 28
\layout LyX-Code

    Identification: 0x0000
\layout LyX-Code

    Flags: 0x00
\layout LyX-Code

        .0..
 = Don't fragment: Not set
\layout LyX-Code

        ..0.
 = More fragments: Not set
\layout LyX-Code

    Fragment offset: 0
\layout LyX-Code

    Time to live: 32
\layout LyX-Code

    Protocol: ICMP (0x01)
\layout LyX-Code

    Header checksum: 0xfde1 (incorrect, should be 0x6fe0)
\layout LyX-Code

    Source: 130.240.2.24 (130.240.2.24)
\layout LyX-Code

    Destination: 130.240.35.9 (130.240.35.9)
\layout LyX-Code

Internet Control Message Protocol
\layout LyX-Code

    Type: 0 (Echo (ping) reply)
\layout LyX-Code

    Code: 0
\layout LyX-Code

    Checksum: 0xfffa (incorrect, should be 0x74fa)
\layout LyX-Code

    Identifier: 0x0100
\layout LyX-Code

    Sequence number: 8a:05 
\end_inset 


\layout Chapter

List of acronyms and abbreviations
\layout Itemize

ASIC - Application Specific Integrated Circuit
\layout Itemize

ARP - Address Resolution Protocol
\layout Itemize

AUI - Attachment Unit Interface
\layout Itemize

BUFGP - Primary Global Buffer for Driving Clocks or Longlines
\layout Itemize

CPU - Central Processing Unit
\layout Itemize

CSEE - Department of Computer Science and Electrical Engineering at Luleå
 University of Technology
\layout Itemize

CSMA/CD - Carrier Sense Multiple Access / Collision Detect
\layout Itemize

DA - Destination Address
\layout Itemize

DCR - Device Control Register Bus (IBM CoreConnect)
\layout Itemize

DMA - Direct Memory Access
\layout Itemize

EDK - Embedded Development Kit
\layout Itemize

EISLAB - Embedded Internet Systems Laboratory
\layout Itemize

EMAC - Xilinx OPB Ethernet Media Access Controller
\layout Itemize

EMAC Lite - Xilinx OPB Ethernet Lite Media Access Controller
\layout Itemize

EthMac - Opencores.org 10/100 Ethernet MAC
\layout Itemize

FCS - Frame Check Sequence
\layout Itemize

FlashRAM - Flashable (Non-Volatile) Random Access Memory
\layout Itemize

FPGA - Field Programmable Gate Array
\layout Itemize

GHz - Giga Hertz
\layout Itemize

GNU - GNU is Not Unix
\layout Itemize

GPL - General Public License
\layout Itemize

GUI - Graphical User Interface
\layout Itemize

I/O - Input/Output
\layout Itemize

IBUF - Input Buffer
\layout Itemize

IBUFG - Dedicated Input Buffer
\layout Itemize

IOBUF - Bi-Directional Buffer
\layout Itemize

JTAG - Joint Test Action Group
\layout Itemize

HDL - Hardware Description Language
\layout Itemize

IBM - International Business Machines Corporation
\layout Itemize

ICMP - Internet Control Message Protocol
\layout Itemize

IP - Internet Protocol
\layout Itemize

IPv4 - Internet Protocol Version 4
\layout Itemize

LMB - Local Memory Bus
\layout Itemize

lwIP - Light Weight Internet Protocol
\layout Itemize

MAC - Media Access Controller
\layout Itemize

MAU - Medium Attachment Unit
\layout Itemize

MBit/s - Mega Bit per second
\layout Itemize

MDK - MicroBlaze Development Kit
\layout Itemize

MHz - Mega Hertz
\layout Itemize

MII - Medium Independent Interface
\layout Itemize

OBUF - Output Buffer
\layout Itemize

OPB - On-Chip Peripheral Bus (IBM CoreConnect)
\layout Itemize

OSI - Open Systems Interconnect
\layout Itemize

PHY - Physical Layer Device
\layout Itemize

PLB - Processor Local Bus (IBM CoreConnect)
\layout Itemize

PLD - Programmable Logic Device
\layout Itemize

PROM - Programmable Read-Only Memory
\layout Itemize

RAM - Random Access Memory
\layout Itemize

RISC - Reduced Instruction Set Computer
\layout Itemize

RMII - Reduced Medium Independent Interface
\layout Itemize

ROM - Read-Only Memory
\layout Itemize

RS-232 - Recommended Standard 232 (asynchronous serial line standard)
\layout Itemize

SA - Source Address
\layout Itemize

SoC - System on Chip
\layout Itemize

SRAM - Static Random Access Memory
\layout Itemize

TCP - Transmission Control Protocol
\layout Itemize

TCP/IP - The Internet Protocol Version 4 protocol suite (TCP, UDP, ICMP
 etc)
\layout Itemize

TYPE - Type-field (Ethernet frames)
\layout Itemize

SYNC - Synchronization bits (Ethernet frames)
\layout Itemize

UART - Universal Asynchronous Receiver/Transmitter
\layout Itemize

UDP - User Datagram Protocol
\layout Itemize

VHDL - Very High Speed Integrated Circuit (VHSIC) Hardware Description Language.
\layout Itemize

VHSIC -Very High Speed Integrated Circuit (VHDL)
\layout Itemize

XST - Xilinx Synthesis Technology
\the_end
